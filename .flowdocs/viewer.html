<!DOCTYPE html>
<html lang="es" class="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FlowDocs</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script>
tailwind.config = {
  darkMode: 'class',
  theme: {
    extend: {
      fontFamily: {
        sans: ['Sora', 'sans-serif'],
        mono: ['JetBrains Mono', 'monospace'],
      },
      colors: {
        surface: { 950: '#0a0a0f', 900: '#0f0f17', 800: '#16161f', 700: '#1e1e2a', 600: '#252535' },
        accent: { DEFAULT: '#6366f1', hover: '#4f46e5', muted: '#6366f120' },
        ok:     { DEFAULT: '#22c55e', muted: '#22c55e18' },
        warn:   { DEFAULT: '#f59e0b', muted: '#f59e0b18' },
        err:    { DEFAULT: '#ef4444', muted: '#ef444418' },
        border: '#ffffff0f',
      }
    }
  }
}
</script>
<style>
* { box-sizing: border-box; }
body { background: #0a0a0f; font-family: 'Sora', sans-serif; color: #e2e8f0; margin: 0; }
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #ffffff18; border-radius: 4px; }
.nav-item { display: flex; align-items: center; gap: 10px; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 13px; color: #94a3b8; transition: all .15s; }
.nav-item:hover { background: #ffffff08; color: #e2e8f0; }
.nav-item.active { background: #6366f120; color: #818cf8; }
.nav-item svg { width: 16px; height: 16px; flex-shrink: 0; }
.badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 99px; font-size: 11px; font-weight: 500; font-family: 'JetBrains Mono'; }
.badge-ok    { background: #22c55e18; color: #4ade80; border: 1px solid #22c55e28; }
.badge-warn  { background: #f59e0b18; color: #fbbf24; border: 1px solid #f59e0b28; }
.badge-err   { background: #ef444418; color: #f87171; border: 1px solid #ef444428; }
.badge-blue  { background: #6366f120; color: #818cf8; border: 1px solid #6366f130; }
.badge-gray  { background: #ffffff0a; color: #64748b; border: 1px solid #ffffff10; }
.card { background: #16161f; border: 1px solid #ffffff0f; border-radius: 12px; }
.flow-card { background: #16161f; border: 1px solid #ffffff0f; border-radius: 10px; padding: 14px; cursor: pointer; transition: all .15s; }
.flow-card:hover { border-color: #6366f140; background: #1a1a25; transform: translateY(-1px); }
.flow-card.selected { border-color: #6366f160; background: #1a1a28; }
.stat-card { background: #16161f; border: 1px solid #ffffff0f; border-radius: 12px; padding: 20px; }
.progress-bar { height: 4px; background: #ffffff0f; border-radius: 99px; overflow: hidden; }
.progress-fill { height: 100%; border-radius: 99px; transition: width .6s ease; }
.view { display: none; }
.view.active { display: block; }
.panel { position: fixed; top: 0; right: -520px; width: 500px; height: 100vh; background: #16161f; border-left: 1px solid #ffffff0f; z-index: 50; transition: right .25s cubic-bezier(.4,0,.2,1); overflow-y: auto; }
.panel.open { right: 0; }
.panel-overlay { position: fixed; inset: 0; background: #00000060; z-index: 49; display: none; }
.panel-overlay.open { display: block; }
table { width: 100%; border-collapse: collapse; }
th { text-align: left; padding: 10px 14px; font-size: 11px; font-weight: 600; color: #475569; text-transform: uppercase; letter-spacing: .08em; border-bottom: 1px solid #ffffff0f; }
td { padding: 12px 14px; font-size: 13px; border-bottom: 1px solid #ffffff07; vertical-align: middle; }
tr:hover td { background: #ffffff04; }
.filter-btn { padding: 6px 12px; border-radius: 6px; font-size: 12px; border: 1px solid #ffffff10; background: transparent; color: #64748b; cursor: pointer; transition: all .15s; font-family: 'Sora'; }
.filter-btn:hover, .filter-btn.active { background: #6366f120; border-color: #6366f140; color: #818cf8; }
.search-input { background: #0f0f17; border: 1px solid #ffffff10; border-radius: 8px; padding: 8px 14px 8px 36px; font-size: 13px; color: #e2e8f0; outline: none; font-family: 'Sora'; width: 260px; }
.search-input:focus { border-color: #6366f140; }
.mermaid { background: #0f0f17 !important; border-radius: 8px; padding: 16px; }
.entity-card { background: #0f0f17; border: 1px solid #ffffff0f; border-radius: 10px; padding: 16px; }
.state-node { display: inline-flex; align-items: center; padding: 4px 12px; border-radius: 99px; font-size: 11px; font-family: 'JetBrains Mono'; font-weight: 500; }
.transition-arrow { display: flex; align-items: center; gap: 8px; padding: 6px 0; font-size: 12px; color: #475569; }
.col-header { background: #0f0f17; border: 1px solid #ffffff0f; border-radius: 10px 10px 0 0; padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; }
.col-body { background: #0a0a0f; border: 1px solid #ffffff0f; border-top: none; border-radius: 0 0 10px 10px; padding: 12px; min-height: 400px; display: flex; flex-direction: column; gap: 8px; }

/* Backlog HU cards (estructura referencia) */
#backlog-content { display: flex; flex-direction: column; gap: 16px; width: 100%; }
.story-card { width: 100%; min-width: 0; background: #0f1117; border: 1px solid #1a1f2e; border-radius: 12px; overflow: hidden; cursor: pointer; transition: border-color .2s, transform .15s; }
.story-card:hover { border-color: #6366f140; transform: translateY(-1px); }
.story-card-header { display: flex; align-items: center; gap: 10px; padding: 14px 16px 12px; }
.story-card-id { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: #475569; }
.story-card-title { font-size: 13px; font-weight: 600; color: #e2e8f0; flex: 1; line-height: 1.4; }
.story-ac-badge { font-size: 11px; font-family: 'JetBrains Mono', monospace; padding: 2px 8px; border-radius: 20px; white-space: nowrap; flex-shrink: 0; }
.story-progress-bar { height: 2px; background: #1e293b; }
.story-progress-fill { height: 100%; border-radius: 2px; transition: width .4s; }
.story-criteria-list { padding: 10px 16px 14px; display: flex; flex-direction: column; gap: 0; }
.story-criterion { display: flex; align-items: flex-start; gap: 9px; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,.04); }
.story-criterion:last-child { border-bottom: none; }
.story-checkbox { width: 15px; height: 15px; border-radius: 3px; border: 1px solid #1e293b; background: transparent; flex-shrink: 0; margin-top: 2px; display: flex; align-items: center; justify-content: center; }
.story-checkbox.checked { background: #10b981; border-color: #10b981; }
.story-criterion-text { font-size: 12px; color: #94a3b8; line-height: 1.5; flex: 1; }
.story-criterion-text.done { color: #475569; text-decoration: line-through; }
.story-chips { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
.story-chip { font-family: 'JetBrains Mono', monospace; font-size: 10px; padding: 2px 7px; border-radius: 20px; border: 1px solid; cursor: pointer; transition: opacity .15s; }
.story-chip:hover { opacity: .75; }
.story-chip-todo   { color: #475569; background: rgba(71,85,105,.12); border-color: rgba(71,85,105,.4); }
.story-chip-doing  { color: #3b82f6; background: rgba(59,130,246,.12); border-color: rgba(59,130,246,.4); }
.story-chip-review { color: #8b5cf6; background: rgba(139,92,246,.12); border-color: rgba(139,92,246,.4); }
.story-chip-done   { color: #10b981; background: rgba(16,185,129,.12); border-color: rgba(16,185,129,.4); }
.story-priority { font-size: 10px; font-family: 'JetBrains Mono', monospace; padding: 2px 7px; border-radius: 4px; flex-shrink: 0; }
.story-priority-critical { background: rgba(239,68,68,.12); color: #f87171; }
.story-priority-high     { background: rgba(245,158,11,.12); color: #fbbf24; }
.story-priority-medium   { background: rgba(59,130,246,.12); color: #60a5fa; }
.story-priority-low      { background: rgba(71,85,105,.2); color: #64748b; }
.story-module { font-size: 10px; color: #475569; font-family: 'JetBrains Mono', monospace; }

/* Story panel (modal de historias) */
.story-panel-header { padding: 20px 22px 16px; border-bottom: 1px solid #1a1f2e; background: linear-gradient(160deg,#0f1225 0%,#0d0f18 60%); position: relative; }
.story-panel-header .header-actions { position: absolute; top: 14px; right: 14px; display: flex; align-items: center; gap: 6px; }
.story-panel-header .legend-btn { width: 22px; height: 22px; border-radius: 50%; border: 1px solid #334155; background: transparent; color: #475569; font-size: 11px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all .15s; }
.story-panel-header .legend-btn:hover { border-color: #6366f1; color: #6366f1; background: #6366f110; }
.story-meta-row { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
.story-meta-id { font-family: 'JetBrains Mono',monospace; font-size: 11px; color: #6366f1; background: #6366f112; border: 1px solid #6366f130; padding: 2px 8px; border-radius: 4px; }
.story-meta-module { font-family: 'JetBrains Mono',monospace; font-size: 10px; color: #475569; }
.story-meta-sprint { font-size: 10px; color: #8b5cf6; background: #8b5cf610; border: 1px solid #8b5cf630; padding: 2px 7px; border-radius: 4px; font-family: 'JetBrains Mono',monospace; margin-left: auto; }
.story-panel-title { font-size: 14px; font-weight: 600; color: #e2e8f0; line-height: 1.5; margin-bottom: 14px; padding-right: 64px; }
.story-header-badges { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
.story-badge-priority { font-size: 10px; font-family: 'JetBrains Mono',monospace; padding: 3px 8px; border-radius: 4px; }
.story-badge-status { font-size: 10px; font-family: 'JetBrains Mono',monospace; padding: 3px 8px; border-radius: 4px; color: #34d399; background: #10b98115; border: 1px solid #10b98130; }
.story-badge-module { font-size: 10px; font-family: 'JetBrains Mono',monospace; padding: 3px 8px; border-radius: 4px; color: #94a3b8; background: #1e293b; border: 1px solid #334155; }
.progress-strip { padding: 12px 22px; border-bottom: 1px solid #1a1f2e; background: #0a0c15; display: flex; align-items: center; gap: 12px; }
.progress-label { font-size: 11px; color: #475569; font-family: 'JetBrains Mono',monospace; white-space: nowrap; }
.progress-track { flex: 1; height: 4px; background: #1e293b; border-radius: 2px; overflow: hidden; }
.progress-track.narrow { max-width: 56px; }
.progress-fill-bar { height: 100%; border-radius: 2px; transition: width .3s; }
.progress-count { font-family: 'JetBrains Mono',monospace; font-size: 12px; font-weight: 600; white-space: nowrap; }
.story-panel-body { overflow-y: auto; max-height: 50vh; padding: 14px 22px 24px; }
.story-section { padding-bottom: 14px; border-bottom: 1px solid #ffffff06; margin-bottom: 14px; }
.story-section:last-of-type { border-bottom: none; margin-bottom: 0; }
.section-title { font-size: 10px; font-family: 'JetBrains Mono',monospace; color: #334155; text-transform: uppercase; letter-spacing: .1em; margin-bottom: 10px; }
.flow-row { display: flex; align-items: center; gap: 8px; padding: 7px 10px; border-radius: 7px; margin-bottom: 4px; background: #0a0c15; border: 1px solid #1a1f2e; transition: border-color .15s; cursor: default; }
.flow-row:last-child { margin-bottom: 0; }
.flow-row:hover { border-color: #6366f140; }
.flow-row.clickable { cursor: pointer; }
.status-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
.ac-id { font-family: 'JetBrains Mono',monospace; font-size: 10px; color: #334155; min-width: 52px; flex-shrink: 0; }
.ac-desc { font-size: 11px; color: #64748b; flex: 1; line-height: 1.4; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.shield-btn { display: inline-flex; align-items: center; justify-content: center; width: 22px; height: 22px; border-radius: 5px; border: 1px solid #10b98130; background: #10b98110; cursor: pointer; color: #10b981; flex-shrink: 0; transition: background .15s; }
.shield-btn:hover { background: #10b98125; }
.shield-btn.no-spec { border-color: #1e293b; background: transparent; color: #1e293b; cursor: default; pointer-events: none; }
.chip-sprint { font-family: 'JetBrains Mono',monospace; font-size: 10px; padding: 2px 7px; border-radius: 20px; border: 1px solid; white-space: nowrap; flex-shrink: 0; }
.chip-sprint.todo { color: #475569; background: #47556915; border-color: #47556940; }
.chip-sprint.doing { color: #3b82f6; background: #3b82f615; border-color: #3b82f640; }
.chip-sprint.review { color: #8b5cf6; background: #8b5cf615; border-color: #8b5cf640; }
.chip-sprint.done { color: #10b981; background: #10b98115; border-color: #10b98140; }
.sprint-badge { font-family: 'JetBrains Mono',monospace; font-size: 10px; padding: 2px 7px; border-radius: 4px; flex-shrink: 0; }
.sprint-badge.todo { color: #475569; background: #1e293b; }
.sprint-badge.doing { color: #60a5fa; background: #3b82f615; border: 1px solid #3b82f630; }
.sprint-badge.review { color: #c084fc; background: #8b5cf615; border: 1px solid #8b5cf630; }
.sprint-badge.done { color: #34d399; background: #10b98115; border: 1px solid #10b98130; }
.spec-list-toggle { display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
.spec-list-toggle .section-title { margin-bottom: 0; }
.spec-list-content { display: none; flex-direction: column; margin-top: 10px; }
.spec-list-content.open { display: flex; }
.spec-list-item { display: flex; align-items: center; gap: 8px; padding: 6px 0; font-family: 'JetBrains Mono',monospace; font-size: 10px; color: #10b981; border-bottom: 1px solid #ffffff04; }
.spec-list-item:last-child { border-bottom: none; }
.overlay-modal { display: none; position: fixed; inset: 0; z-index: 60; align-items: center; justify-content: center; background: #000000a0; backdrop-filter: blur(5px); padding: 20px; box-sizing: border-box; }
.overlay-modal.open { display: flex; }
@keyframes scaleIn { from { opacity:0; transform:scale(.96) translateY(6px); } to { opacity:1; transform:scale(1) translateY(0); } }
.spec-modal-box { background: #0d0f1a; border: 1px solid #1e293b; border-radius: 14px; width: 460px; max-width: calc(100vw - 40px); max-height: 90vh; overflow-y: auto; overflow-x: hidden; flex-shrink: 0; box-shadow: 0 32px 80px #000000ee; animation: scaleIn .18s ease; }
.spec-modal-header { display: flex; align-items: center; gap: 10px; padding: 14px 18px; border-bottom: 1px solid #1e293b; background: #0a0c15; }
.spec-modal-ac { font-family: 'JetBrains Mono',monospace; font-size: 11px; color: #10b981; background: #10b98112; border: 1px solid #10b98130; padding: 2px 8px; border-radius: 4px; flex-shrink: 0; }
.spec-modal-desc { font-size: 11px; color: #64748b; flex: 1; line-height: 1.4; min-width: 0; overflow: hidden; text-overflow: ellipsis; }
.evidence-area { background: #070810; min-height: 180px; display: flex; align-items: center; justify-content: center; }
.evidence-area img { max-width: 100%; max-height: 300px; object-fit: contain; display: block; }
.evidence-empty { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 40px; color: #1e293b; }
.evidence-empty span { font-family: 'JetBrains Mono',monospace; font-size: 10px; }
.spec-files-area { padding: 12px 18px; border-top: 1px solid #1e293b; }
.spec-files-label { font-size: 10px; font-family: 'JetBrains Mono',monospace; color: #334155; text-transform: uppercase; letter-spacing: .08em; margin-bottom: 8px; }
.spec-file-row { display: flex; align-items: center; gap: 8px; padding: 6px 10px; background: #0a0c15; border: 1px solid #10b98120; border-radius: 6px; margin-bottom: 4px; font-family: 'JetBrains Mono',monospace; font-size: 11px; color: #10b981; }
.spec-file-row:last-child { margin-bottom: 0; }
.spec-modal-footer { display: flex; justify-content: flex-end; padding: 10px 18px; border-top: 1px solid #1e293b; background: #0a0c15; }
.legend-modal-box { background: #0d0f1a; border: 1px solid #1e293b; border-radius: 14px; padding: 20px 22px; width: 340px; max-width: calc(100vw - 40px); flex-shrink: 0; box-shadow: 0 32px 80px #000000ee; animation: scaleIn .18s ease; }
.legend-group-title { font-size: 10px; font-family: 'JetBrains Mono',monospace; color: #334155; text-transform: uppercase; letter-spacing: .08em; padding-bottom: 6px; border-bottom: 1px solid #ffffff06; margin-bottom: 8px; margin-top: 16px; }
.legend-group-title:first-of-type { margin-top: 0; }
.legend-row { display: flex; align-items: center; gap: 10px; padding: 4px 0; }
.legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.legend-label { font-size: 12px; color: #94a3b8; flex: 1; }
.legend-desc { font-size: 10px; color: #334155; font-family: 'JetBrains Mono',monospace; }
</style>
</head>
<body>

<!-- Layout -->
<div style="display:flex; height:100vh; overflow:hidden;">

  <!-- Sidebar -->
  <aside style="width:220px; background:#0f0f17; border-right:1px solid #ffffff0f; display:flex; flex-direction:column; flex-shrink:0;">
    <!-- Logo -->
    <div style="padding:20px 16px 16px;">
      <div style="display:flex; align-items:center; gap:8px;">
        <div style="width:28px;height:28px;background:linear-gradient(135deg,#6366f1,#8b5cf6);border-radius:7px;display:flex;align-items:center;justify-content:center;">
          <svg width="14" height="14" fill="none" stroke="white" stroke-width="2.5" viewBox="0 0 24 24"><path d="M3 6l3 1m0 0l-3 9a5 5 0 006.027 6.27M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5 5 0 01-6.027 6.27M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5"/></svg>
        </div>
        <span style="font-weight:700; font-size:15px; color:#e2e8f0;">FlowDocs</span>
      </div>
    </div>

    <!-- Nav -->
    <nav style="flex:1; padding:0 8px; display:flex; flex-direction:column; gap:2px;">
      <div class="nav-item active" id="nav-dashboard" onclick="showView('dashboard')">
        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
        Dashboard
      </div>
      <div class="nav-item" id="nav-backlog" onclick="showView('backlog')">
        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2M12 12h.01M12 16h.01"/></svg>
        Backlog
      </div>
      <div class="nav-item" id="nav-board" onclick="showView('board')">
        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="5" height="18" rx="1"/><rect x="10" y="3" width="5" height="12" rx="1"/><rect x="17" y="3" width="5" height="15" rx="1"/></svg>
        Tablero
      </div>
      <div class="nav-item" id="nav-list" onclick="showView('list')">
        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
        Flujos
      </div>
      <div class="nav-item" id="nav-entities" onclick="showView('entities')">
        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 2v3M12 19v3M4.22 4.22l2.12 2.12M17.66 17.66l2.12 2.12M2 12h3M19 12h3M4.22 19.78l2.12-2.12M17.66 6.34l2.12-2.12"/></svg>
        Entidades
      </div>
    </nav>

    <!-- Project info (meta.app, meta.version, meta.updated_at, meta.description) -->
    <div style="padding:12px 16px; border-top:1px solid #ffffff0f;">
      <div style="font-size:11px; color:#475569; margin-bottom:4px;">PROYECTO</div>
      <div id="sidebar-app" style="font-size:13px; font-weight:600; color:#e2e8f0;">—</div>
      <div id="sidebar-version" style="font-size:11px; color:#475569; font-family:'JetBrains Mono';">—</div>
      <div id="sidebar-updated" style="font-size:10px; color:#334155; margin-top:4px;">—</div>
      <div id="sidebar-description" style="font-size:11px; color:#475569; margin-top:6px; line-height:1.4; max-height:36px; overflow:hidden; text-overflow:ellipsis;" title=""></div>
    </div>
  </aside>

  <!-- Main -->
  <div style="flex:1; display:flex; flex-direction:column; overflow:hidden;">

    <!-- Topbar -->
    <header style="height:52px; border-bottom:1px solid #ffffff0f; display:flex; align-items:center; padding:0 24px; gap:16px; flex-shrink:0; background:#0a0a0f;">
      <div id="view-title" style="font-size:14px; font-weight:600; color:#e2e8f0;">Dashboard</div>
      <div style="flex:1;"></div>
      <div style="display:flex; align-items:center; gap:6px;">
        <span id="data-source-hint" style="font-size:11px; font-family:'JetBrains Mono'; color:#334155; background:#ffffff06; padding:4px 10px; border-radius:6px; border:1px solid #ffffff08;">—</span>
        <button type="button" onclick="reloadYaml()" style="font-size:10px; padding:4px 8px; border-radius:4px; border:1px solid #ffffff15; background:#ffffff08; color:#94a3b8; cursor:pointer;">Recargar</button>
        <input type="file" id="file-yaml-input" accept=".yaml,.yml,text/yaml" style="display:none" onchange="onYamlFileSelected(event)">
        <button type="button" onclick="document.getElementById('file-yaml-input').click()" style="font-size:10px; padding:4px 8px; border-radius:4px; border:1px solid #ffffff15; background:#ffffff08; color:#94a3b8; cursor:pointer;" title="Si abriste el viewer como file://, usa esto para elegir flows.yaml">Cargar archivo</button>
      </div>
    </header>

    <!-- Aviso cuando file:// y sin YAML cargado -->
    <div id="file-protocol-banner" style="display:none; padding:10px 24px; background:#f59e0b18; border-bottom:1px solid #f59e0b30; font-size:12px; color:#fbbf24;">
      Abriste el viewer como archivo local. Para ver <strong>tu</strong> proyecto: usa el botón <strong>Cargar archivo</strong> (arriba a la derecha) y elige <code style="background:#00000030;padding:2px 6px;border-radius:4px;">flows.yaml</code> de esta carpeta.
    </div>

    <!-- Content area -->
    <main style="flex:1; overflow-y:auto; min-height:0;">

      <!-- DASHBOARD VIEW -->
      <div id="view-dashboard" class="view active" style="padding:24px;">

        <!-- Stats row -->
        <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:14px; margin-bottom:20px;">
          <div class="stat-card">
            <div style="font-size:11px;color:#475569;text-transform:uppercase;letter-spacing:.08em;margin-bottom:10px;">Total Flujos</div>
            <div id="stat-total" style="font-size:32px;font-weight:700;color:#e2e8f0;font-family:'JetBrains Mono';">—</div>
            <div style="font-size:11px;color:#475569;margin-top:4px;">en el proyecto</div>
          </div>
          <div class="stat-card">
            <div style="font-size:11px;color:#475569;text-transform:uppercase;letter-spacing:.08em;margin-bottom:10px;">Implementados</div>
            <div id="stat-implemented" style="font-size:32px;font-weight:700;color:#4ade80;font-family:'JetBrains Mono';">—</div>
            <div class="progress-bar" style="margin-top:10px;"><div id="bar-implemented" class="progress-fill" style="background:#22c55e;width:0%"></div></div>
          </div>
          <div class="stat-card">
            <div style="font-size:11px;color:#475569;text-transform:uppercase;letter-spacing:.08em;margin-bottom:10px;">Sin Tests</div>
            <div id="stat-notests" style="font-size:32px;font-weight:700;color:#f87171;font-family:'JetBrains Mono';">—</div>
            <div class="progress-bar" style="margin-top:10px;"><div id="bar-notests" class="progress-fill" style="background:#ef4444;width:0%"></div></div>
          </div>
          <div class="stat-card">
            <div style="font-size:11px;color:#475569;text-transform:uppercase;letter-spacing:.08em;margin-bottom:10px;">Cobertura</div>
            <div id="stat-coverage" style="font-size:32px;font-weight:700;color:#fbbf24;font-family:'JetBrains Mono';">—</div>
            <div class="progress-bar" style="margin-top:10px;"><div id="bar-coverage" class="progress-fill" style="background:#f59e0b;width:0%"></div></div>
          </div>
        </div>

        <!-- Modules + Critical -->
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">

          <!-- Módulos -->
          <div class="card" style="padding:20px;">
            <div style="font-size:13px;font-weight:600;color:#e2e8f0;margin-bottom:16px;">Estado por Módulo</div>
            <div id="modules-list" style="display:flex;flex-direction:column;gap:12px;"></div>
          </div>

          <!-- Críticos sin tests -->
          <div class="card" style="padding:20px;">
            <div style="font-size:13px;font-weight:600;color:#e2e8f0;margin-bottom:4px;">Flujos Críticos sin Tests</div>
            <div style="font-size:11px;color:#475569;margin-bottom:16px;">Prioridad inmediata</div>
            <div id="critical-list" style="display:flex;flex-direction:column;gap:8px;"></div>
          </div>
        </div>

        <!-- Partial flows -->
        <div class="card" style="padding:20px; margin-top:16px;">
          <div style="font-size:13px;font-weight:600;color:#e2e8f0;margin-bottom:4px;">Flujos Parcialmente Implementados</div>
          <div style="font-size:11px;color:#475569;margin-bottom:16px;">Requieren atención antes del siguiente sprint</div>
          <div id="partial-list" style="display:flex;flex-direction:column;gap:8px;"></div>
        </div>

      </div>

      <!-- BACKLOG VIEW -->
      <div id="view-backlog" class="view" style="padding:24px;">
        <div id="sprint-selector-backlog" style="display:flex;align-items:center;gap:8px;margin-bottom:16px;flex-wrap:wrap;"></div>
        <div id="sprint-banner" style="background:linear-gradient(135deg,#1e293b,#0f172a);border:1px solid #334155;border-radius:12px;padding:20px 24px;margin-bottom:20px;display:flex;align-items:center;gap:24px;flex-wrap:wrap;"></div>
        <div id="backlog-content"></div>
      </div>

      <div id="view-board" class="view" style="padding:24px;">
        <!-- Sprint filter -->
        <div id="sprint-selector-board" style="display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap;"></div>
        <!-- Filters -->
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:20px;flex-wrap:wrap;">
          <span style="font-size:11px;color:#475569;margin-right:4px;">MÓDULO</span>
          <div id="board-module-filters" style="display:flex;gap:6px;flex-wrap:wrap;"></div>
          <div style="width:1px;height:20px;background:#ffffff0f;margin:0 8px;"></div>
          <span style="font-size:11px;color:#475569;margin-right:4px;">TIPO</span>
          <div id="board-type-filters" style="display:flex;gap:6px;flex-wrap:wrap;"></div>
        </div>

        <!-- Columns -->
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px;align-items:start;">
          <div>
            <div class="col-header">
              <div style="display:flex;align-items:center;gap:8px;">
                <div style="width:8px;height:8px;border-radius:50%;background:#475569;"></div>
                <span style="font-size:12px;font-weight:600;color:#e2e8f0;">Por Hacer</span>
              </div>
              <span id="count-pending" class="badge badge-gray">0</span>
            </div>
            <div id="col-pending" class="col-body"></div>
          </div>
          <div>
            <div class="col-header">
              <div style="display:flex;align-items:center;gap:8px;">
                <div style="width:8px;height:8px;border-radius:50%;background:#3b82f6;"></div>
                <span style="font-size:12px;font-weight:600;color:#e2e8f0;">En Progreso</span>
              </div>
              <span id="count-partial" class="badge badge-gray">0</span>
            </div>
            <div id="col-partial" class="col-body"></div>
          </div>
          <div>
            <div class="col-header">
              <div style="display:flex;align-items:center;gap:8px;">
                <div style="width:8px;height:8px;border-radius:50%;background:#22c55e;"></div>
                <span style="font-size:12px;font-weight:600;color:#e2e8f0;">Revisión / Hecho</span>
              </div>
              <span id="count-implemented" class="badge badge-gray">0</span>
            </div>
            <div id="col-implemented" class="col-body"></div>
          </div>
        </div>
      </div>

      <!-- LIST VIEW -->
      <div id="view-list" class="view" style="padding:24px;">
        <!-- Search + filters -->
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;flex-wrap:wrap;">
          <div style="position:relative;">
            <svg style="position:absolute;left:10px;top:50%;transform:translateY(-50%);width:14px;height:14px;color:#475569;" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
            <input class="search-input" id="search-input" placeholder="Buscar flujos..." oninput="filterList()">
          </div>
          <div id="list-module-filters" style="display:flex;gap:6px;flex-wrap:wrap;"></div>
          <div style="flex:1;"></div>
          <button onclick="exportCSV()" style="display:flex;align-items:center;gap:6px;padding:7px 14px;border-radius:7px;border:1px solid #ffffff10;background:transparent;color:#64748b;font-size:12px;cursor:pointer;font-family:'Sora';">
            <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
            Exportar CSV
          </button>
        </div>

        <!-- Table -->
        <div class="card" style="overflow:hidden;">
          <div style="overflow-x:auto;">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nombre</th>
                  <th>Módulo</th>
                  <th>Tipo</th>
                  <th>Estado</th>
                  <th>Tests</th>
                  <th>Prioridad</th>
                </tr>
              </thead>
              <tbody id="list-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ENTITIES VIEW -->
      <div id="view-entities" class="view" style="padding:24px;">
        <div style="font-size:12px;color:#475569;margin-bottom:16px;">Ciclo de vida de entidades y sus transiciones de estado</div>
        <div id="entities-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:16px;"></div>
      </div>

    </main>
  </div>
</div>

<!-- Panel lateral -->
<div class="panel-overlay" id="overlay" onclick="closePanel()"></div>
<div class="panel" id="detail-panel">
  <div id="panel-wrapper" style="padding:24px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
      <div id="panel-id" style="font-family:'JetBrains Mono';font-size:12px;color:#475569;"></div>
      <button onclick="closePanel()" style="background:none;border:none;color:#475569;cursor:pointer;padding:4px;">
        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg>
      </button>
    </div>
    <div id="panel-content"></div>
  </div>
</div>

<!-- Modales del story panel (spec + evidence, leyenda) -->
<div class="overlay-modal" id="overlay-spec">
  <div class="spec-modal-box" onclick="event.stopPropagation()">
    <div class="spec-modal-header">
      <div style="width:28px;height:28px;border-radius:6px;border:1px solid #10b98130;background:#10b98110;display:flex;align-items:center;justify-content:center;color:#10b981;flex-shrink:0;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 3l8 3.5v5c0 4.5-3.5 8.5-8 9.5-4.5-1-8-5-8-9.5v-5L12 3z"/><path d="M9 12l2 2 4-4"/></svg></div>
      <span class="spec-modal-ac" id="sm-ac">—</span>
      <span class="spec-modal-desc" id="sm-desc"></span>
      <button type="button" class="close-btn" onclick="closeSpecModal()" style="width:26px;height:26px;border-radius:6px;border:1px solid #1e293b;background:transparent;color:#475569;cursor:pointer;display:flex;align-items:center;justify-content:center;"><svg width="10" height="10" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M1 1l10 10M11 1L1 11"/></svg></button>
    </div>
    <div class="evidence-area" id="sm-evidence-area">
      <div class="evidence-empty" id="sm-no-evidence">
        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><rect x="3" y="5" width="18" height="14" rx="2"/><circle cx="8.5" cy="10.5" r="1.5"/><path d="M21 15l-5-5L5 19"/></svg>
        <span>Sin evidencia adjunta</span>
      </div>
      <img id="sm-img" src="" alt="" style="display:none;" onerror="this.style.display='none';var ne=document.getElementById('sm-no-evidence');if(ne){ne.style.display='flex';ne.querySelector('span').textContent='Sin evidencia adjunta';}">
    </div>
    <div class="spec-files-area">
      <div class="spec-files-label">Spec Files</div>
      <div id="sm-files"></div>
    </div>
    <div class="spec-modal-footer">
      <button type="button" class="close-btn" onclick="closeSpecModal()" style="width:auto;padding:0 14px;gap:6px;font-size:10px;font-family:'JetBrains Mono',monospace;color:#475569;">Cerrar</button>
    </div>
  </div>
</div>
<div class="overlay-modal" id="overlay-legend">
  <div class="legend-modal-box" onclick="event.stopPropagation()">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <span style="font-size:13px;font-weight:600;color:#e2e8f0;">Guía de Indicadores</span>
      <button type="button" class="close-btn" onclick="closeLegendModal()" style="width:26px;height:26px;border-radius:6px;border:1px solid #1e293b;background:transparent;color:#475569;cursor:pointer;display:flex;align-items:center;justify-content:center;"><svg width="10" height="10" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M1 1l10 10M11 1L1 11"/></svg></button>
    </div>
    <div class="legend-group-title">Criterios — Dot</div>
    <div class="legend-row"><div class="legend-dot" style="background:#10b981;box-shadow:0 0 6px #10b98160;"></div><span class="legend-label">Validado + spec + evidence</span><span class="legend-desc">100% demostrado</span></div>
    <div class="legend-row"><div class="legend-dot" style="background:#3b82f6;box-shadow:0 0 6px #3b82f660;"></div><span class="legend-label">Validado + spec</span><span class="legend-desc">cubierto en tests</span></div>
    <div class="legend-row"><div class="legend-dot" style="background:#f59e0b;box-shadow:0 0 6px #f59e0b60;"></div><span class="legend-label">Validado sin respaldo</span><span class="legend-desc">marcado manual</span></div>
    <div class="legend-row"><div class="legend-dot" style="background:#334155;"></div><span class="legend-label">Pendiente</span><span class="legend-desc">sin validar</span></div>
    <div class="legend-group-title">Flujos — Sprint Status</div>
    <div class="legend-row"><div class="legend-dot" style="background:#475569;"></div><span class="legend-label">todo</span><span class="legend-desc">sin iniciar</span></div>
    <div class="legend-row"><div class="legend-dot" style="background:#3b82f6;box-shadow:0 0 6px #3b82f660;"></div><span class="legend-label">doing</span><span class="legend-desc">en desarrollo</span></div>
    <div class="legend-row"><div class="legend-dot" style="background:#8b5cf6;box-shadow:0 0 6px #8b5cf660;"></div><span class="legend-label">review</span><span class="legend-desc">en revisión</span></div>
    <div class="legend-row"><div class="legend-dot" style="background:#10b981;box-shadow:0 0 6px #10b98160;"></div><span class="legend-label">done</span><span class="legend-desc">completado</span></div>
    <div class="legend-group-title">Ícono de Criterio</div>
    <div class="legend-row"><div style="width:22px;height:22px;border-radius:5px;border:1px solid #10b98130;background:#10b98110;display:flex;align-items:center;justify-content:center;color:#10b981;flex-shrink:0;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 3l8 3.5v5c0 4.5-3.5 8.5-8 9.5-4.5-1-8-5-8-9.5v-5L12 3z"/><path d="M9 12l2 2 4-4"/></svg></div><span class="legend-label">Shield check</span><span class="legend-desc">click → spec + evidence</span></div>
    <div class="legend-group-title">Chips de Flujo</div>
    <div class="legend-row"><span class="chip-sprint todo" style="min-width:64px;text-align:center;">FLOW-001</span><span class="legend-label" style="margin-left:4px;">todo</span></div>
    <div class="legend-row"><span class="chip-sprint doing" style="min-width:64px;text-align:center;">FLOW-002</span><span class="legend-label" style="margin-left:4px;">doing</span></div>
    <div class="legend-row"><span class="chip-sprint review" style="min-width:64px;text-align:center;">FLOW-003</span><span class="legend-label" style="margin-left:4px;">review</span></div>
    <div class="legend-row"><span class="chip-sprint done" style="min-width:64px;text-align:center;">FLOW-004</span><span class="legend-label" style="margin-left:4px;">done</span></div>
  </div>
</div>

<script>
// ============================================================
// DATOS MOCK (simula el flows.yaml parseado)
// ============================================================
const MOCK_DATA = {
  "meta": {
    "app": "Orquestra",
    "version": "1.0.0",
    "description": "Plataforma web enfocada exclusivamente en la Landing Page corporativa, flujos de captación de leads (Contacto/Demo) y navegación enterprise.",
    "updated_at": "2026-02-22",
    "sprint": {
      "number": 1,
      "goal": "Lanzamiento de Landing Page y Funnels de Conversión",
      "start": "2026-02-22",
      "end": "2026-03-07",
      "days_left": 13
    },
    "stats": {
      "total": 5,
      "implemented": 5,
      "partial": 0,
      "pending": 0,
      "with_tests": 0,
      "coverage_pct": 0
    }
  },
  "modules": [
    {
      "id": "landing",
      "name": "Landing Page",
      "description": "Página de aterrizaje pública y escaparate del producto. Incluye hero, beneficios, capacidades clave, y modelo de arquitectura modular para transmitir madurez enterprise.",
      "actors": [
        "visitante",
        "evaluador_tecnico",
        "director"
      ]
    },
    {
      "id": "contact_flow",
      "name": "Flujo de Contacto",
      "description": "Módulo de captación de leads generales y consultas corporativas. Emplea un formulario validado con envío de notificaciones y experiencia de éxito.",
      "actors": [
        "visitante"
      ]
    },
    {
      "id": "demo_flow",
      "name": "Flujo de Demo Guiada",
      "description": "Módulo especializado en captación de leads de alta intención (Decision Makers). Exige campos de calificación y promete agendamiento de sesión técnica.",
      "actors": [
        "tomador_decision",
        "cto"
      ]
    },
    {
      "id": "navigation",
      "name": "Navegación Global",
      "description": "Sistema de enrutamiento y anclaje (Navbar, Footer, enlaces cruzados) que garantiza la cohesión entre la landing, rutas dinámicas y secciones de contenido.",
      "actors": [
        "visitante",
        "todos"
      ]
    }
  ],
  "entities": [
    {
      "id": "visitor",
      "name": "Visitante Público",
      "states": [
        "exploring",
        "bounced"
      ],
      "transitions": []
    },
    {
      "id": "lead",
      "name": "Lead Corporativo",
      "states": [
        "captured",
        "contacted",
        "qualified"
      ],
      "transitions": [
        {
          "from": "captured",
          "to": "contacted",
          "action": "Asesor contacta al lead vía email/teléfono"
        }
      ]
    }
  ],
  "stories": [
    {
      "id": "US-001",
      "title": "Landing enterprise orientada a decisión ejecutiva",
      "module": "landing",
      "priority": "high",
      "status": "implemented",
      "sprint": 1,
      "story_points": 8,
      "actors": [
        "visitante",
        "director",
        "tomador_decision"
      ],
      "narrative": "Como director o responsable de transformación digital, quiero ingresar a la landing de Orquestra y comprender en segundos que se trata de una plataforma empresarial modular, confiable y escalable, para evaluar rápidamente su adopción y acceder a una demostración.\n",
      "business_context": {
        "product_positioning": "Plataforma enterprise modular tipo ecosystem-driven (similar a Salesforce AppExchange mindset)",
        "key_message": "Activa solo las capacidades que tu organización necesita",
        "differentiation": [
          "Arquitectura por extensiones activables",
          "Marketplace integrado",
          "Enfoque enterprise-first",
          "Time-to-value acelerado"
        ]
      },
      "ux_intent": {
        "primary_goal": "Conversión a demo",
        "secondary_goal": "Confianza ejecutiva",
        "tertiary_goal": "Comprensión del modelo modular",
        "emotional_tone": [
          "corporativo",
          "confiable",
          "moderno",
          "tecnológicamente sólido"
        ]
      },
      "information_architecture": {
        "required_sections": [
          "Hero estratégico",
          "Propuesta de valor empresarial",
          "Modelo de plataforma modular",
          "Capacidades clave",
          "Extensiones destacadas",
          "Beneficios enterprise/cloud",
          "CTA de conversión",
          "Footer institucional"
        ]
      },
      "acceptance_criteria": [
        {
          "id": "AC-001",
          "name": "Hero con posicionamiento ejecutivo",
          "description": "La sección hero comunica inmediatamente que Orquestra es una plataforma empresarial modular. Debe incluir: - H1 orientado a transformación operativa medible - Subtítulo que mencione explícitamente el modelo por extensiones - Mockup limpio tipo dashboard enterprise - CTA primario hacia demo - CTA secundario informativo\n",
          "validations": [
            "El valor modular se entiende en ≤5 segundos",
            "Existe exactamente un H1",
            "El hero es above-the-fold en desktop",
            "El diseño transmite estética enterprise (no startup genérica)"
          ],
          "validated": true,
          "flow_ids": [
            "FLOW-001"
          ]
        },
        {
          "id": "AC-002",
          "name": "Sección de propuesta de valor",
          "description": "Existe una sección que explica claramente que Orquestra permite construir soluciones empresariales mediante la activación de extensiones bajo demanda.\n",
          "validations": [
            "Se menciona explícitamente el concepto de extensiones",
            "Se comunica el beneficio de usar solo lo necesario",
            "El lenguaje es corporativo, no técnico excesivo",
            "La jerarquía visual guía la lectura ejecutiva"
          ],
          "validated": true,
          "flow_ids": [
            "FLOW-002"
          ]
        },
        {
          "id": "AC-003",
          "name": "Modelo de plataforma modular",
          "description": "Existe una sección visual que explique el flujo: Organización → Activación de extensiones → Solución operativa.\n",
          "validations": [
            "El flujo se entiende sin leer texto largo",
            "Existe apoyo visual (diagrama, steps o visual flow)",
            "Refuerza el concepto de escalabilidad"
          ],
          "validated": true,
          "flow_ids": [
            "FLOW-002"
          ]
        },
        {
          "id": "AC-004",
          "name": "Capacidades empresariales",
          "description": "Existe una sección de capacidades clave con cards (ej. multi-organización, KPI, automatización, gobierno de datos).\n",
          "validations": [
            "Las capacidades están orientadas a empresa, no a usuario individual",
            "Iconografía consistente",
            "Grid responsive",
            "Hover states en desktop"
          ],
          "validated": true,
          "flow_ids": [
            "FLOW-002"
          ]
        },
        {
          "id": "AC-005",
          "name": "Extensiones destacadas como marketplace",
          "description": "La landing muestra extensiones (KPI, Encuestas, BI) claramente etiquetadas como 'Extensión' o 'Módulo activable', reforzando el modelo tipo marketplace.\n",
          "validations": [
            "Cada item tiene badge de extensión",
            "Se entiende que pueden activarse bajo demanda",
            "La sección transmite mentalidad de ecosystem"
          ],
          "validated": true,
          "flow_ids": [
            "FLOW-002"
          ]
        },
        {
          "id": "AC-006",
          "name": "Beneficios enterprise y cloud",
          "description": "Existe una sección que comunique atributos enterprise: seguridad, escalabilidad, multi-tenant, alta disponibilidad.\n",
          "validations": [
            "Lenguaje orientado a TI/directores",
            "Diseño visual diferenciado (sección premium)",
            "No usa claims vacíos sin contexto"
          ],
          "validated": true,
          "flow_ids": [
            "FLOW-002"
          ]
        },
        {
          "id": "AC-007",
          "name": "Navegación corporativa",
          "description": "La navbar sticky muestra logo Orquestra y navegación clara orientada a exploración ejecutiva.\n",
          "validations": [
            "Sticky funcional",
            "Responsive con menú móvil",
            "Estados hover y focus",
            "Accesible por teclado"
          ],
          "validated": true,
          "flow_ids": [
            "FLOW-003"
          ]
        },
        {
          "id": "AC-008",
          "name": "Experiencia responsive premium",
          "description": "La landing mantiene calidad visual y legibilidad en móvil, tablet y desktop.\n",
          "validations": [
            "Sin scroll horizontal en 320px",
            "CTAs táctiles ≥44px",
            "Tipografía escala correctamente",
            "Las secciones mantienen jerarquía visual"
          ],
          "validated": true,
          "flow_ids": [
            "FLOW-001"
          ]
        },
        {
          "id": "AC-009",
          "name": "CTA final orientado a decisión",
          "description": "La página cierra con un bloque de conversión que invite a solicitar demo o información, reforzando confianza enterprise.\n",
          "validations": [
            "Ubicado antes del footer",
            "Mensaje orientado a valor de negocio",
            "Botón primario consistente con design system"
          ],
          "validated": true,
          "flow_ids": [
            "FLOW-002"
          ]
        }
      ],
      "non_functional_requirements": {
        "performance": [
          "Lighthouse ≥ 90",
          "LCP < 2.5s",
          "CLS < 0.1"
        ],
        "accessibility": [
          "WCAG 2.1 AA básico",
          "Navegación por teclado"
        ],
        "seo": [
          "Metadata completa",
          "OpenGraph",
          "Estructura semántica correcta"
        ]
      },
      "definition_of_done": [
        "La propuesta modular se entiende claramente",
        "La página transmite confianza enterprise",
        "Todos los AC validados",
        "Build de producción exitoso",
        "Revisión UX aprobada"
      ]
    },
    {
      "id": "US-002",
      "title": "Página de contacto corporativa con confirmación de envío",
      "module": "landing",
      "priority": "high",
      "status": "implemented",
      "sprint": 1,
      "story_points": 8,
      "actors": [
        "visitante",
        "cto",
        "director",
        "tomador_decision"
      ],
      "narrative": "Como Director de Tecnología o responsable de evaluar plataformas, quiero acceder a una página de contacto clara, moderna y confiable para solicitar información sobre precios, planes y capacidades de Orquestra, y recibir confirmación inmediata de que mi mensaje fue enviado correctamente.\n",
      "business_goal": [
        "Capturar leads calificados enterprise",
        "Reducir fricción en el primer contacto",
        "Transmitir confianza corporativa",
        "Preparar pipeline comercial"
      ],
      "ux_intent": {
        "primary_goal": "Envío exitoso del formulario",
        "secondary_goal": "Generar confianza post-envío",
        "emotional_tone": [
          "profesional",
          "moderno",
          "enterprise",
          "confiable",
          "sin fricción"
        ]
      },
      "functional_scope": {
        "form_fields_required": [
          "Nombre completo",
          "Correo corporativo",
          "Organización",
          "Rol",
          "Mensaje"
        ],
        "optional_fields": [
          "Teléfono",
          "Tamaño de la organización",
          "Interés principal (planes, demo, partnership, etc.)"
        ],
        "system_behaviors": [
          "Validación en tiempo real",
          "Estado de carga al enviar",
          "Mensaje de éxito visible",
          "Envío de correo al equipo comercial",
          "Correo de confirmación al usuario",
          "Prevención de spam básica"
        ]
      },
      "acceptance_criteria": [
        {
          "id": "AC-001",
          "name": "Diseño corporativo de la página",
          "description": "La página de contacto presenta un layout moderno, limpio y alineado al design system enterprise de Orquestra.\n",
          "validations": [
            "Jerarquía visual clara",
            "Espaciado consistente",
            "Tipografía enterprise",
            "Responsive completo"
          ],
          "validated": true
        },
        {
          "id": "AC-002",
          "name": "Formulario intuitivo",
          "description": "El formulario es fácil de completar para un ejecutivo, con labels claros, placeholders útiles y agrupación lógica.\n",
          "validations": [
            "Tiempo estimado de llenado ≤ 60 segundos",
            "Campos obligatorios marcados",
            "Errores visibles inline",
            "Navegación por teclado funcional"
          ],
          "validated": true
        },
        {
          "id": "AC-003",
          "name": "Sugerencias inteligentes de mensaje",
          "description": "La UI muestra ejemplos o chips de ayuda sobre qué puede solicitar el usuario (ej. precios, demo, arquitectura).\n",
          "validations": [
            "Existen al menos 4 sugerencias visibles",
            "Al hacer click se insertan en el textarea",
            "No interfieren con escritura manual"
          ],
          "validated": true
        },
        {
          "id": "AC-004",
          "name": "Envío funcional del formulario",
          "description": "Al enviar, el sistema procesa la solicitud de forma asíncrona y muestra estado de carga.\n",
          "validations": [
            "Botón muestra loading state",
            "Se evita doble envío",
            "Timeout manejado correctamente",
            "Errores de red manejados"
          ],
          "validated": true
        },
        {
          "id": "AC-005",
          "name": "Confirmación visual inmediata",
          "description": "Tras envío exitoso, el usuario ve un mensaje claro de confirmación sin abandonar la página.\n",
          "validations": [
            "Mensaje de éxito visible",
            "Tono corporativo y tranquilizador",
            "Incluye expectativa de tiempo de respuesta",
            "Accesible por lectores de pantalla"
          ],
          "validated": true
        },
        {
          "id": "AC-006",
          "name": "Correo recibido por el equipo",
          "description": "El sistema envía un email estructurado al equipo comercial con la información del lead.\n",
          "validations": [
            "Incluye todos los campos",
            "Formato legible",
            "Timestamp incluido",
            "Ambiente configurable (dev/prod)"
          ],
          "validated": true
        },
        {
          "id": "AC-007",
          "name": "Correo de confirmación al usuario",
          "description": "El usuario recibe un correo automático confirmando la recepción de su solicitud.\n",
          "validations": [
            "Enviado al correo capturado",
            "Incluye resumen del mensaje",
            "Branding de Orquestra",
            "Tiempo estimado de respuesta"
          ],
          "validated": true
        },
        {
          "id": "AC-008",
          "name": "Experiencia responsive premium",
          "description": "La página mantiene usabilidad y estética en móvil, tablet y desktop.\n",
          "validations": [
            "Sin scroll horizontal en 320px",
            "Campos táctiles ≥44px",
            "CTA visible en viewport móvil"
          ],
          "validated": true
        },
        {
          "id": "AC-009",
          "name": "Protección básica anti-spam",
          "description": "El formulario implementa al menos una medida anti-spam.\n",
          "validations": [
            "Honeypot o equivalente",
            "Rate limiting básico",
            "Validación de dominio de correo"
          ],
          "validated": true
        }
      ],
      "non_functional_requirements": {
        "performance": [
          "Tiempo de envío percibido < 2s",
          "Sin bloqueo del main thread"
        ],
        "accessibility": [
          "WCAG 2.1 AA",
          "ARIA live en mensaje de éxito"
        ],
        "security": [
          "Sanitización de inputs",
          "Protección contra XSS",
          "Validación server-side obligatoria"
        ]
      },
      "analytics_events": [
        "contact_form_view",
        "contact_form_submit",
        "contact_form_success",
        "contact_form_error"
      ],
      "definition_of_done": [
        "Formulario envía correctamente",
        "Usuario recibe correo de confirmación",
        "Equipo recibe lead",
        "UX aprobada por diseño",
        "Tests básicos pasando",
        "Sin errores en consola"
      ]
    },
    {
      "id": "US-003",
      "title": "Solicitud de demo guiada con captura de lead calificado",
      "module": "landing",
      "priority": "high",
      "status": "implemented",
      "sprint": 1,
      "story_points": 8,
      "actors": [
        "visitante",
        "cto",
        "director",
        "tomador_decision"
      ],
      "narrative": "Como Director de Tecnología o responsable de evaluar plataformas, quiero solicitar una demo de Orquestra desde la landing, proporcionando mis datos de forma rápida y profesional, para que el equipo comercial me contacte y me muestre el producto.\n",
      "strategic_note": "Esta funcionalidad reutiliza la infraestructura del formulario de contacto, pero optimizada para intención de compra (high-intent lead).\n",
      "business_goal": [
        "Capturar leads de alta intención",
        "Acelerar pipeline comercial",
        "Reducir fricción para solicitud de demo",
        "Segmentar prospectos enterprise"
      ],
      "ux_intent": {
        "primary_goal": "Solicitud de demo completada",
        "secondary_goal": "Percepción de proceso enterprise",
        "emotional_tone": [
          "premium",
          "ágil",
          "confiable",
          "orientado a negocio"
        ]
      },
      "reuse_strategy": {
        "base_component": "ContactForm",
        "reuse_level": "alto",
        "differences": [
          "copy orientado a demo",
          "tracking específico",
          "campos de calificación opcionales",
          "ruta dedicada /demo"
        ]
      },
      "functional_scope": {
        "entry_points": [
          "Hero CTA 'Solicitar demo'",
          "CTA final de la landing",
          "Navbar (opcional futuro)"
        ],
        "form_fields_required": [
          "Nombre completo",
          "Correo corporativo",
          "Organización",
          "Rol"
        ],
        "recommended_fields": [
          "Tamaño de la organización",
          "Interés principal",
          "¿Qué deseas ver en la demo?"
        ],
        "system_behaviors": [
          "Apertura en página dedicada o modal",
          "Validación en tiempo real",
          "Loading state",
          "Confirmación visual",
          "Email al equipo comercial",
          "Email de confirmación al solicitante"
        ]
      },
      "acceptance_criteria": [
        {
          "id": "AC-001",
          "name": "Navegación desde CTA",
          "description": "Al hacer click en 'Solicitar demo', el usuario es dirigido a la experiencia de solicitud de demo sin fricción.\n",
          "validations": [
            "Navegación client-side",
            "Tiempo de transición < 300ms",
            "Evento analytics disparado"
          ],
          "validated": true
        },
        {
          "id": "AC-002",
          "name": "Experiencia diferenciada de demo",
          "description": "La página o modal comunica claramente que se trata de una solicitud de demo guiada.\n",
          "validations": [
            "Headline orientado a demo",
            "Microcopy de expectativa de contacto",
            "Diseño consistente con branding"
          ],
          "validated": true
        },
        {
          "id": "AC-003",
          "name": "Formulario optimizado para lead calificado",
          "description": "El formulario reutiliza el componente base pero prioriza rapidez y calidad del lead.\n",
          "validations": [
            "Tiempo de llenado ≤ 60s",
            "Campos obligatorios mínimos",
            "Validación inline",
            "Accesible por teclado"
          ],
          "validated": true
        },
        {
          "id": "AC-004",
          "name": "Envío y estado de carga",
          "description": "Al enviar la solicitud, el sistema procesa de forma asíncrona mostrando feedback visual.\n",
          "validations": [
            "Botón muestra loading",
            "Prevención de doble submit",
            "Errores manejados"
          ],
          "validated": true
        },
        {
          "id": "AC-005",
          "name": "Confirmación post-solicitud",
          "description": "Tras envío exitoso, el usuario ve confirmación clara con expectativa de contacto.\n",
          "validations": [
            "Mensaje visible",
            "Tono corporativo",
            "Incluye tiempo estimado de respuesta",
            "ARIA live presente"
          ],
          "validated": true
        },
        {
          "id": "AC-006",
          "name": "Notificación al equipo comercial",
          "description": "El sistema envía email estructurado marcando el lead como 'Demo Request'.\n",
          "validations": [
            "Incluye metadata de origen",
            "Timestamp",
            "Campos completos"
          ],
          "validated": true
        },
        {
          "id": "AC-007",
          "name": "Correo de confirmación al solicitante",
          "description": "El usuario recibe confirmación automática de que su demo fue solicitada.\n",
          "validations": [
            "Branding Orquestra",
            "Resumen de solicitud",
            "Próximos pasos claros"
          ],
          "validated": true
        },
        {
          "id": "AC-008",
          "name": "Experiencia responsive premium",
          "description": "La solicitud de demo funciona correctamente en móvil, tablet y desktop.\n",
          "validations": [
            "Sin overflow en 320px",
            "Inputs táctiles ≥44px",
            "CTA visible"
          ],
          "validated": true
        }
      ],
      "analytics_events": [
        "demo_cta_click",
        "demo_form_view",
        "demo_form_submit",
        "demo_form_success",
        "demo_form_error"
      ],
      "non_functional_requirements": {
        "performance": [
          "Tiempo de envío percibido < 2s"
        ],
        "accessibility": [
          "WCAG 2.1 AA"
        ],
        "security": [
          "Validación server-side",
          "Sanitización inputs",
          "Protección anti-spam"
        ]
      },
      "definition_of_done": [
        "Solicitud de demo funcional",
        "Correos enviados correctamente",
        "Tracking activo",
        "UX aprobada",
        "Sin errores en consola"
      ]
    },
    {
      "id": "US-004",
      "title": "Diferenciación clara entre Contacto y Solicitar demo",
      "module": "landing",
      "priority": "high",
      "status": "implemented",
      "sprint": 1,
      "story_points": 5,
      "actors": [
        "visitante",
        "cto",
        "director",
        "tomador_decision"
      ],
      "narrative": "Como Director de Tecnología evaluando Orquestra, experimenté confusión entre el formulario de Contacto y el de Solicitar demo porque ambos se ven y funcionan igual. Quiero que cada experiencia esté claramente diferenciada en propósito, mensaje y ayudas visuales, para saber cuál utilizar según mi necesidad.\n",
      "problem_statement": {
        "current_issue": "Los formularios de Contacto y Solicitar demo comparten estructura, ayudas y apariencia casi idéntica, lo que genera ambigüedad en la intención del usuario.\n",
        "business_risk": [
          "Fricción en conversión",
          "Leads mal calificados",
          "Experiencia poco enterprise",
          "Duda en el decision maker"
        ],
        "user_impact": [
          "No sé cuál elegir",
          "No entiendo la diferencia",
          "Percibo falta de madurez del producto"
        ]
      },
      "business_goal": [
        "Eliminar ambigüedad entre flujos",
        "Mejorar calidad de leads",
        "Aumentar conversión a demo",
        "Transmitir madurez enterprise"
      ],
      "ux_intent": {
        "primary_goal": "Claridad de propósito por flujo",
        "secondary_goal": "Reducir fricción cognitiva",
        "emotional_tone": [
          "claro",
          "guiado",
          "enterprise",
          "intencional"
        ]
      },
      "differentiation_strategy": {
        "required_differences": [
          "headline específico por flujo",
          "subcopy contextual",
          "sugerencias inteligentes distintas",
          "campo adicional en demo",
          "microcopy de expectativa diferente",
          "tracking diferenciado"
        ],
        "visual_differences": [
          "iconografía contextual",
          "badge o label del flujo",
          "hero/header distinto",
          "orden de campos optimizado por intención"
        ]
      },
      "acceptance_criteria": [
        {
          "id": "AC-001",
          "name": "Propósito explícito por página",
          "description": "Cada página comunica claramente su objetivo antes de mostrar el formulario.\n",
          "validations": [
            "Contacto orientado a preguntas generales",
            "Demo orientado a ver el producto",
            "Headline distinto en cada página",
            "Subtítulo contextual"
          ],
          "validated": true
        },
        {
          "id": "AC-002",
          "name": "Sugerencias inteligentes diferenciadas",
          "description": "Los chips de ayuda del formulario son distintos entre Contacto y Demo.\n",
          "validations": [
            "Contacto muestra preguntas informativas",
            "Demo muestra intereses de demo",
            "No comparten exactamente los mismos textos"
          ],
          "validated": true
        },
        {
          "id": "AC-003",
          "name": "Campo adicional en solicitud de demo",
          "description": "El formulario de demo incluye al menos un campo específico de calificación de demo.\n",
          "validations": [
            "Existe campo '¿Qué deseas ver en la demo?'",
            "No aparece en contacto",
            "Es opcional pero visible"
          ],
          "validated": true
        },
        {
          "id": "AC-004",
          "name": "Microcopy de expectativa diferenciada",
          "description": "El mensaje previo al envío explica claramente qué ocurrirá después en cada flujo.\n",
          "validations": [
            "Contacto promete respuesta informativa",
            "Demo promete agendamiento o contacto comercial",
            "Lenguaje corporativo"
          ],
          "validated": true
        },
        {
          "id": "AC-005",
          "name": "Confirmaciones post-envío distintas",
          "description": "El mensaje de éxito refleja el tipo de solicitud.\n",
          "validations": [
            "Contacto: confirmación de recepción",
            "Demo: próximos pasos de demo",
            "Incluyen tiempos estimados"
          ],
          "validated": true
        },
        {
          "id": "AC-006",
          "name": "Tracking diferenciado",
          "description": "Analytics distingue claramente ambos flujos.\n",
          "validations": [
            "contact_form_submit",
            "demo_form_submit",
            "No se mezclan eventos"
          ],
          "validated": true
        },
        {
          "id": "AC-007",
          "name": "Reutilización técnica sin duplicación",
          "description": "El sistema reutiliza el componente base manteniendo diferenciación por variante.\n",
          "validations": [
            "Existe LeadForm reutilizable",
            "Uso de prop variant",
            "Sin lógica duplicada"
          ],
          "validated": true
        }
      ],
      "non_functional_requirements": {
        "ux_quality": [
          "La diferencia se entiende en <5 segundos",
          "No aumenta el tiempo de llenado"
        ],
        "accessibility": [
          "WCAG 2.1 AA"
        ],
        "performance": [
          "Sin impacto perceptible en carga"
        ]
      },
      "definition_of_done": [
        "Usuarios distinguen claramente ambos flujos",
        "Sin duplicación de lógica",
        "UX validada",
        "Eventos analytics correctos",
        "Copy aprobado por negocio"
      ]
    },
    {
      "id": "US-005",
      "title": "Como usuario corporativo quiero que la navegación funcione correctamente desde /contacto y /demo para acceder al contenido sin errores.",
      "module": "navigation",
      "priority": "high",
      "status": "implemented",
      "sprint": 2,
      "related_to": [
        "US-001",
        "US-002",
        "US-003",
        "US-004"
      ],
      "persona": "Director de Tecnología / Evaluador de plataforma",
      "user_story": "Como evaluador de la plataforma Orquestra, cuando navego desde las páginas /contacto o /demo, quiero que los enlaces del menú (Producto, Plataforma, Capacidades) me lleven correctamente al contenido correspondiente, para no perder contexto ni experimentar confusión durante la evaluación del producto.\n",
      "problem_statement": "Actualmente, al hacer clic en los enlaces de navegación desde /contacto o /demo, la aplicación solo concatena anclas (por ejemplo: /contacto#producto), lo que no muestra el contenido esperado porque dichas secciones existen únicamente en la landing (/). Esto genera fricción, sensación de producto inmaduro y rompe el flujo de exploración.\n",
      "expected_experience": "La navegación debe sentirse consistente, corporativa y confiable. Desde cualquier página, el usuario debe poder llegar a las secciones clave de la plataforma sin importar en qué ruta se encuentre.\n",
      "acceptance_criteria": [
        {
          "id": "AC-001",
          "description": "Desde /contacto y /demo, al hacer clic en \"Producto\", el usuario es redirigido a la landing (/) con scroll automático a la sección #producto.\n",
          "validated": true
        },
        {
          "id": "AC-002",
          "description": "Desde /contacto y /demo, al hacer clic en \"Plataforma\", el usuario es redirigido a /#plataforma con desplazamiento suave.\n",
          "validated": true
        },
        {
          "id": "AC-003",
          "description": "Desde /contacto y /demo, al hacer clic en \"Capacidades\", el usuario es redirigido a /#capacidades mostrando el contenido correctamente.\n",
          "validated": true
        },
        {
          "id": "AC-004",
          "description": "La navegación detecta automáticamente si el usuario está fuera de la landing y ajusta el href para incluir la ruta base (/).\n",
          "validated": true
        },
        {
          "id": "AC-005",
          "description": "El comportamiento es consistente en navegación desktop y móvil.\n",
          "validated": true
        },
        {
          "id": "AC-006",
          "description": "Se implementa scroll suave (smooth scroll) al llegar a la sección destino.\n",
          "validated": true
        },
        {
          "id": "AC-007",
          "description": "No se generan rutas inválidas como /contacto#producto o /demo#capacidades.\n",
          "validated": true
        },
        {
          "id": "AC-008",
          "description": "La experiencia de navegación transmite calidad enterprise y continuidad de producto.\n",
          "validated": true
        }
      ],
      "technical_notes": "Posibles soluciones técnicas:\n\nOpción A (recomendada):\n  - Normalizar links del navbar:\n    /#producto\n    /#plataforma\n    /#capacidades\n\nOpción B:\n  - Detectar pathname actual con usePathname()\n  - Si !== '/', hacer router.push('/#seccion')\n\nOpción C (más robusta enterprise):\n  - Centralizar configuración de navegación\n  - NavigationMap.ts\n  - Scroll manager global\n\nConsiderar:\n  - next/link con scroll={false}\n  - manejo de hash después de navegación\n  - compatibilidad con App Router\n",
      "business_value": "Corrige un bug visible en la experiencia de navegación que afecta la percepción de madurez del producto. Mejora la confianza del evaluador corporativo y mantiene la continuidad del journey comercial.\n",
      "definition_of_done": [
        "Navegación funcional desde cualquier ruta",
        "Scroll correcto a secciones de la landing",
        "Sin rutas con hash incorrectas",
        "Validado en móvil y desktop",
        "Revisado por QA"
      ]
    }
  ],
  "flows": [
    {
      "id": "FLOW-001",
      "name": "Exploración de la Landing Page",
      "type": "user_flow",
      "module": "landing",
      "actor": "visitante",
      "priority": "high",
      "status": "implemented",
      "story": "US-001",
      "trigger": "El usuario accede a la raíz (/)",
      "steps": [
        "El sistema renderiza el Hero Section con posicionamiento enterprise.",
        "El usuario hace scroll visualizando secciones de beneficios, arquitectura modular y capacidades.",
        "El usuario interactúa con los CTAs (ej. 'Ver demo')."
      ]
    },
    {
      "id": "FLOW-002",
      "name": "Navegación Cruzada y Scroll Suave",
      "type": "user_flow",
      "module": "navigation",
      "actor": "visitante",
      "priority": "high",
      "status": "implemented",
      "story": "US-005",
      "trigger": "El usuario hace clic en el Navbar desde una ruta interna (ej. /contacto)",
      "steps": [
        "El usuario hace clic en 'Plataforma' en el menú principal.",
        "El sistema enruta a la landing (/) usando Next Link.",
        "El navegador realiza un scroll suave hacia la sección '/#plataforma'.",
        "El usuario no pierde contexto ni encuentra enlaces rotos."
      ]
    },
    {
      "id": "FLOW-003",
      "name": "Envío de Consulta de Contacto",
      "type": "user_flow",
      "module": "contact_flow",
      "actor": "visitante",
      "priority": "high",
      "status": "implemented",
      "story": "US-002",
      "trigger": "El usuario navega a /contacto y llena el formulario",
      "steps": [
        "El usuario ve un formulario orientado a dudas generales con chips informativos.",
        "El usuario completa el mensaje y hace clic en Enviar.",
        "El sistema valida los datos con Zod y muestra estado de carga.",
        "El sistema redirige a una pantalla de éxito confirmando la recepción.",
        "Se registra el evento 'contact_request' originando un nuevo Lead en la plataforma."
      ]
    },
    {
      "id": "FLOW-004",
      "name": "Solicitud de Demo Calificada",
      "type": "user_flow",
      "module": "demo_flow",
      "actor": "tomador_decision",
      "priority": "high",
      "status": "implemented",
      "story": "US-003, US-004",
      "trigger": "El usuario hace clic en 'Solicitar Demo' desde el Hero o Navbar",
      "steps": [
        "El sistema navega a la ruta optimizada /demo sin footer para evitar distracciones.",
        "El usuario ve propuesta de valor lateral y un formulario con un badge 'Sesión técnica'.",
        "El usuario completa los campos, incluyendo 'Detalles de la demo' (específico para calificar ventas).",
        "El sistema valida e higieniza los datos mediante Zod.",
        "El sistema muestra pantalla de éxito orientada a agendamiento en < 24h.",
        "Se envía la metadata y se asigna el estado 'demo_request' al Lead."
      ]
    }
  ]
};

// ============================================================
// CARGA DE flows.yaml (mismo directorio que viewer.html)
// ============================================================
function resolveActiveSprint(meta) {
  const sprints = meta.sprints;
  const activeNum = meta.active_sprint;
  if (Array.isArray(sprints) && sprints.length && ('active_sprint' in meta)) {
    const found = sprints.find(s => String(s.number) === String(activeNum));
    if (found) {
      let days = found.days_left;
      if (days == null && found.start && found.end) {
        const end = new Date(found.end);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        end.setHours(0, 0, 0, 0);
        days = Math.max(0, Math.ceil((end - today) / (24 * 60 * 60 * 1000)));
      }
      return { number: found.number, goal: found.goal ?? '', start: found.start ?? '', end: found.end ?? '', days_left: days ?? 0 };
    }
  }
  return meta.sprint || {};
}

function normalizeData(raw) {
  const meta = raw.meta || MOCK_DATA.meta;
  const stats = meta.stats || MOCK_DATA.meta.stats || {};
  const sprintResolved = resolveActiveSprint(meta) || meta.sprint || MOCK_DATA.meta.sprint || {};
  const sprint = { number: sprintResolved.number ?? 1, goal: sprintResolved.goal ?? '', start: sprintResolved.start ?? '', end: sprintResolved.end ?? '', days_left: sprintResolved.days_left ?? 0 };
  return {
    meta: {
      app: meta.app ?? MOCK_DATA.meta.app,
      version: meta.version ?? MOCK_DATA.meta.version,
      description: meta.description ?? MOCK_DATA.meta.description,
      updated_at: meta.updated_at ?? MOCK_DATA.meta.updated_at,
      sprint,
      stats: { total: stats.total ?? 0, implemented: stats.implemented ?? 0, partial: stats.partial ?? 0, pending: stats.pending ?? 0, with_tests: stats.with_tests ?? 0, coverage_pct: stats.coverage_pct ?? 0 }
    },
    modules: Array.isArray(raw.modules) ? raw.modules : MOCK_DATA.modules,
    entities: Array.isArray(raw.entities) ? raw.entities : MOCK_DATA.entities,
    stories: Array.isArray(raw.stories) ? raw.stories : MOCK_DATA.stories,
    flows: Array.isArray(raw.flows) ? raw.flows : MOCK_DATA.flows
  };
}

async function loadFlowDocs() {
  if (window.location.protocol === 'file:') {
    return normalizeData(MOCK_DATA);
  }
  try {
    const r = await fetch('flows.yaml', { cache: 'no-store' });
    if (!r.ok) throw new Error(r.statusText);
    const text = await r.text();
    const raw = typeof jsyaml !== 'undefined' ? jsyaml.load(text) : null;
    if (!raw) throw new Error('YAML no parseado');
    return normalizeData(raw);
  } catch (e) {
    console.warn('FlowDocs: no se pudo cargar flows.yaml:', e.message);
    return normalizeData(MOCK_DATA);
  }
}

function onYamlFileSelected(ev) {
  const f = ev.target.files && ev.target.files[0];
  if (!f) return;
  const reader = new FileReader();
  reader.onload = function() {
    try {
      const raw = typeof jsyaml !== 'undefined' ? jsyaml.load(reader.result) : null;
      if (!raw) throw new Error('YAML no parseado');
      data = normalizeData(raw);
      dataSource = 'file';
      selectedSprintFilter = (data.meta.active_sprint != null) ? data.meta.active_sprint : 'all';
      updateDataSourceHint();
      renderDashboard();
      if (activeView === 'backlog') renderBacklog();
      if (activeView === 'board') renderBoard();
      if (activeView === 'list') renderList();
      if (activeView === 'entities') renderEntities();
    } catch (e) {
      console.error('FlowDocs: error al parsear el archivo:', e);
    }
    ev.target.value = '';
  };
  reader.readAsText(f, 'UTF-8');
}

// ============================================================
// STATE
// ============================================================
let data = MOCK_DATA;
let dataSource = 'mock';
let activeView = 'dashboard';
let boardModuleFilter = 'all';
let boardTypeFilter = 'all';
let listModuleFilter = 'all';
let searchQuery = '';
let selectedFlow = null;
/** Filtro de sprint en Backlog/Tablero: 'all' | 'backlog' | número de sprint */
let selectedSprintFilter = 'all';

/** Devuelve las stories que corresponden al filtro de sprint actual */
function getStoriesForSprintFilter() {
  const list = data.stories || [];
  if (selectedSprintFilter === 'all') return list;
  if (selectedSprintFilter === 'backlog') return list.filter(s => s.sprint == null || s.sprint === undefined || s.sprint === '');
  return list.filter(s => Number(s.sprint) === Number(selectedSprintFilter));
}

/** Cambia el filtro de sprint y re-renderiza la vista activa (backlog o board) */
function setSelectedSprintFilter(val) {
  selectedSprintFilter = val;
  if (activeView === 'backlog') renderBacklog();
  if (activeView === 'board') renderBoard();
}

/** Rellena un contenedor con botones de filtro por sprint (Todos, Backlog, Sprint 1, Sprint 2, ...) */
function renderSprintSelector(containerId) {
  const el = document.getElementById(containerId);
  if (!el) return;
  const sprints = data.meta.sprints || [];
  const isActive = (v) => (v === 'all' && selectedSprintFilter === 'all') || (v === 'backlog' && selectedSprintFilter === 'backlog') || (typeof v === 'number' && Number(selectedSprintFilter) === v);
  let html = `<span style="font-size:11px;color:#475569;margin-right:6px;">SPRINT</span>`;
  html += `<button class="filter-btn ${isActive('all') ? 'active' : ''}" onclick="setSelectedSprintFilter('all')">Todos</button>`;
  html += `<button class="filter-btn ${isActive('backlog') ? 'active' : ''}" onclick="setSelectedSprintFilter('backlog')">Backlog</button>`;
  sprints.forEach(s => {
    const n = (s && typeof s === 'object' && s.number != null) ? s.number : (typeof s === 'number' ? s : null);
    if (n == null) return;
    html += `<button class="filter-btn ${isActive(n) ? 'active' : ''}" onclick="setSelectedSprintFilter(${Number(n)})">Sprint ${n}</button>`;
  });
  el.innerHTML = html;
}

// ============================================================
// UTILS
// ============================================================
const typeLabels = { user_flow:'User Flow', task_flow:'Task Flow', business_flow:'Business Flow', data_flow:'Data Flow', error_flow:'Error Flow', system_flow:'System Flow', integration_flow:'Integration' };
const priorityLabels = { critical:'Crítico', high:'Alto', medium:'Medio', low:'Bajo' };

function statusBadge(s) {
  if(s==='implemented') return '<span class="badge badge-ok">● Implementado</span>';
  if(s==='partial')     return '<span class="badge badge-warn">◐ Parcial</span>';
  return '<span class="badge badge-err">○ Pendiente</span>';
}
function testBadge(s) {
  if(s==='covered') return '<span class="badge badge-ok">✓ Tests</span>';
  if(s==='partial') return '<span class="badge badge-warn">~ Parcial</span>';
  return '<span class="badge badge-err">✕ Sin tests</span>';
}
function priorityBadge(p) {
  if(p==='critical') return '<span class="badge badge-err">Crítico</span>';
  if(p==='high')     return '<span class="badge badge-warn">Alto</span>';
  if(p==='medium')   return '<span class="badge badge-blue">Medio</span>';
  return '<span class="badge badge-gray">Bajo</span>';
}
function moduleName(id) {
  const m = data.modules.find(m=>m.id===id);
  return m ? m.name : id;
}

// Criterio: formato nuevo { id, description, validated, flow_ids, evidence } o legacy string / { text, validated_by }.
// HU está done cuando todos los criterios tienen validated: true.
function normCriterion(c, storyFlows) {
  const text = typeof c === 'string' ? c : (c.description || c.text || '');
  let implemented = false;
  if (typeof c === 'object' && c !== null && 'validated' in c) {
    implemented = c.validated === true;
  } else if (typeof c === 'object' && c !== null && c.validated_by && storyFlows && storyFlows.length) {
    implemented = storyFlows.some(f => (f.test_files || []).some(tf => tf === c.validated_by || (tf && tf.includes(c.validated_by))));
  }
  const evidence = (typeof c === 'object' && c !== null && Array.isArray(c.evidence)) ? c.evidence : [];
  return { text, implemented, evidence };
}
// Flujos que implementan/validan este criterio: ac.flow_ids (nuevo) o legacy por validated_by en test_files.
function flowsForCriterion(c, storyFlows) {
  if (!storyFlows || !storyFlows.length) return [];
  const ids = typeof c === 'object' && c !== null && Array.isArray(c.flow_ids) ? c.flow_ids : [];
  if (ids.length) return storyFlows.filter(f => ids.includes(f.id));
  const validatedBy = typeof c === 'object' && c !== null ? c.validated_by : null;
  if (!validatedBy) return [];
  return storyFlows.filter(f => (f.test_files || []).some(tf => tf === validatedBy || (tf && tf.includes(validatedBy))));
}
/** Spec files para un criterio: validated_by (string) o test_files de los flujos que lo cubren */
function getSpecsForCriterion(c, storyFlows) {
  const by = typeof c === 'object' && c !== null ? c.validated_by : null;
  if (by) return [by];
  const flows = flowsForCriterion(c, storyFlows);
  const files = flows.flatMap(f => f.test_files || []);
  return [...new Set(files)];
}
/** Estilo del dot del criterio: validated+spec+evidence=verde, validated+spec=azul, validated=amber, else gris */
function criterionDotStyle(c, storyFlows) {
  const { implemented, evidence } = normCriterion(c, storyFlows);
  const specs = getSpecsForCriterion(c, storyFlows);
  const hasSpec = specs.length > 0;
  if (!implemented) return { bg: '#334155', glow: 'none' };
  if (hasSpec && evidence && evidence.length) return { bg: '#10b981', glow: '0 0 5px #10b98155' };
  if (hasSpec) return { bg: '#3b82f6', glow: '0 0 5px #3b82f655' };
  return { bg: '#f59e0b', glow: '0 0 5px #f59e0b55' };
}
const flowTagColors = ['#14532d','#3b1f5e','#1e3a5f','#713f12','#134e4a'];
function flowTagPills(flows) {
  if (!flows || !flows.length) return '';
  return flows.map((f, i) => {
    const hex = flowTagColors[i % flowTagColors.length];
    const fg = hex === '#14532d' || hex === '#134e4a' ? '#4ade80' : hex === '#1e3a5f' ? '#60a5fa' : hex === '#3b1f5e' ? '#c084fc' : '#fbbf24';
    return `<span onclick="event.stopPropagation();openPanel('${f.id}')" style="display:inline-block;font-size:10px;font-family:'JetBrains Mono';padding:2px 8px;border-radius:99px;margin-right:6px;margin-top:4px;cursor:pointer;background:${hex}40;color:${fg};border:1px solid ${hex}60;">${f.id}</span>`;
  }).join('');
}
function sprintStatusChipClass(s) {
  const map = { todo: 'story-chip-todo', doing: 'story-chip-doing', review: 'story-chip-review', done: 'story-chip-done' };
  return map[s] || 'story-chip-todo';
}
function flowChipsHtml(flows) {
  if (!flows || !flows.length) return '';
  return flows.map(f => {
    const cls = sprintStatusChipClass(f.sprint_status || 'todo');
    return `<span class="story-chip ${cls}" data-flow-id="${String(f.id).replace(/"/g,'&quot;')}">${f.id}</span>`;
  }).join('');
}
const checkSvg = '<svg width="9" height="9" viewBox="0 0 10 10" fill="none"><path d="M2 5l2.5 2.5L8 3" stroke="white" stroke-width="1.5" stroke-linecap="round"/></svg>';
function evidenceHtml(evidenceList) {
  if (!evidenceList || !evidenceList.length) return '';
  return evidenceList.map(ev => {
    const ext = (ev.split('.').pop() || '').toLowerCase();
    const isVideo = ['mp4','webm'].includes(ext);
    const safe = String(ev).replace(/"/g,'&quot;');
    if (isVideo) return `<a href="${safe}" target="_blank" rel="noopener" style="font-size:10px;color:#14b8a6;margin-right:8px;">🎬 Vídeo</a>`;
    return `<a href="${safe}" target="_blank" rel="noopener" style="display:inline-block;margin-right:6px;"><img src="${safe}" alt="Evidencia" style="max-width:80px;max-height:50px;object-fit:cover;border-radius:4px;border:1px solid #334155;" onerror="this.style.display='none'"/></a>`;
  }).join('');
}
function criterionRow(c, i, storyFlows) {
  const { text, implemented, evidence } = normCriterion(c, storyFlows);
  const safe = String(text).replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const icon = implemented
    ? '<span style="color:#22c55e;font-weight:bold;" title="Cubierto por prueba e2e">✓</span>'
    : '<span style="color:#475569;" title="Sin prueba e2e que lo valide">○</span>';
  const evBlock = evidence.length ? `<div style="margin-top:6px;">${evidenceHtml(evidence)}</div>` : '';
  return `<div style="padding:4px 0;padding-left:8px;border-left:2px solid ${implemented?'#22c55e40':'#6366f140'};"><div style="display:flex;align-items:flex-start;gap:8px;font-size:12px;"><span style="flex-shrink:0;width:14px;">${icon}</span><span style="color:${implemented?'#64748b':'#94a3b8'}">${i+1}. ${safe}</span></div>${evBlock}</div>`;
}
// Fila de criterio para la tarjeta del backlog (checkbox + texto + chips + evidencia).
function criterionCardRow(c, i, storyFlows) {
  const { text, implemented, evidence } = normCriterion(c, storyFlows);
  const safe = String(text).replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const flows = flowsForCriterion(c, storyFlows);
  const checkbox = implemented
    ? `<div class="story-checkbox checked">${checkSvg}</div>`
    : '<div class="story-checkbox"></div>';
  const chips = flowChipsHtml(flows);
  const evBlock = evidence.length ? `<div style="margin-top:4px;">${evidenceHtml(evidence)}</div>` : '';
  return `<div class="story-criterion">
    ${checkbox}
    <div style="flex:1;">
      <div class="story-criterion-text ${implemented ? 'done' : ''}">${safe}</div>
      ${chips ? `<div class="story-chips">${chips}</div>` : ''}
      ${evBlock}
    </div>
  </div>`;
}

// ============================================================
// VIEW SWITCHING
// ============================================================
function showView(name) {
  activeView = name;
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('view-' + name).classList.add('active');
  document.getElementById('nav-' + name).classList.add('active');
  const titles = { dashboard:'Dashboard', backlog:'Backlog', board:'Tablero Sprint', list:'Flujos', entities:'Entidades' };
  document.getElementById('view-title').textContent = titles[name] || name;
  if(name==='backlog')  renderBacklog();
  if(name==='board')    renderBoard();
  if(name==='list')     renderList();
  if(name==='entities') renderEntities();
}

// ============================================================
// DASHBOARD
// ============================================================
function renderDashboard() {
  const s = data.meta.stats;
  const total = s.total || 0;
  document.getElementById('sidebar-app').textContent = data.meta.app || '—';
  document.getElementById('sidebar-version').textContent = data.meta.version ? `v${data.meta.version}` : '—';
  const sidebarUpdated = document.getElementById('sidebar-updated');
  if (sidebarUpdated) { sidebarUpdated.textContent = data.meta.updated_at ? `Actualizado: ${data.meta.updated_at}` : ''; }
  const sidebarDesc = document.getElementById('sidebar-description');
  if (sidebarDesc) { sidebarDesc.textContent = data.meta.description || ''; sidebarDesc.title = data.meta.description || ''; }

  const flowCount = (data.flows && data.flows.length) || 0;
  const totalFlows = flowCount > 0 ? flowCount : (total || 0);
  document.getElementById('stat-total').textContent = totalFlows;
  document.getElementById('stat-implemented').textContent = s.implemented ?? 0;
  document.getElementById('stat-notests').textContent = Math.max(0, totalFlows - (s.with_tests ?? 0));
  document.getElementById('stat-coverage').textContent = (s.coverage_pct ?? 0) + '%';

  const impPct = totalFlows ? Math.round((s.implemented ?? 0) / totalFlows * 100) : 0;
  const noTestPct = totalFlows ? Math.round((totalFlows - (s.with_tests ?? 0)) / totalFlows * 100) : 0;
  document.getElementById('bar-implemented').style.width = impPct + '%';
  document.getElementById('bar-notests').style.width = noTestPct + '%';
  document.getElementById('bar-coverage').style.width = (s.coverage_pct ?? 0) + '%';

  // Modules (id, name, description, actors) — mostrar TODOS los módulos del YAML, aunque tengan 0 flujos
  const ml = document.getElementById('modules-list');
  ml.innerHTML = '';
  data.modules.forEach(mod => {
    const flows = data.flows.filter(f=>f.module===mod.id);
    const impl = flows.filter(f=>f.status==='implemented').length;
    const part = flows.filter(f=>f.status==='partial').length;
    const pct = flows.length ? Math.round(impl/flows.length*100) : 0;
    const color = flows.length === 0 ? '#475569' : (pct===100?'#22c55e':pct>50?'#f59e0b':'#ef4444');
    const actors = Array.isArray(mod.actors) ? mod.actors.join(', ') : (mod.actors || '');
    ml.innerHTML += `
      <div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
          <span style="font-size:13px;color:#cbd5e1;">${mod.name}</span>
          <span style="font-size:11px;font-family:'JetBrains Mono';color:${color};">${impl}/${flows.length}</span>
        </div>
        ${mod.description ? `<div style="font-size:11px;color:#64748b;margin-bottom:6px;line-height:1.3;">${mod.description}</div>` : ''}
        ${actors ? `<div style="font-size:10px;color:#334155;margin-bottom:6px;">Actores: ${actors}</div>` : ''}
        <div class="progress-bar">
          <div class="progress-fill" style="background:${color};width:${pct}%"></div>
        </div>
        <div style="display:flex;gap:6px;margin-top:6px;">
          <span class="badge badge-ok" style="font-size:10px;">${impl} ok</span>
          ${part?`<span class="badge badge-warn" style="font-size:10px;">${part} parcial</span>`:''}
        </div>
      </div>`;
  });

  // Critical sin tests
  const cl = document.getElementById('critical-list');
  cl.innerHTML = '';
  const critNoTest = data.flows.filter(f=>f.priority==='critical'&&(f.test_status||'none')==='none');
  if(!critNoTest.length) {
    cl.innerHTML = '<div style="font-size:12px;color:#22c55e;padding:8px 0;">✓ Todos los flujos críticos tienen tests</div>';
  } else {
    critNoTest.forEach(f=>{
      cl.innerHTML += `
        <div onclick="openPanel('${f.id}')" style="display:flex;align-items:center;gap:10px;padding:8px 10px;background:#0f0f17;border-radius:8px;cursor:pointer;border:1px solid #ffffff08;">
          <span style="font-family:'JetBrains Mono';font-size:11px;color:#475569;">${f.id}</span>
          <span style="font-size:12px;color:#cbd5e1;flex:1;">${f.name}</span>
          <span class="badge badge-err" style="font-size:10px;">sin tests</span>
        </div>`;
    });
  }

  // Partial
  const pl = document.getElementById('partial-list');
  pl.innerHTML = '';
  const partials = data.flows.filter(f=>f.status==='partial');
  if(!partials.length) {
    pl.innerHTML = '<div style="font-size:12px;color:#22c55e;padding:8px 0;">✓ Sin flujos parciales</div>';
  } else {
    partials.forEach(f=>{
      pl.innerHTML += `
        <div onclick="openPanel('${f.id}')" style="display:flex;align-items:center;gap:10px;padding:8px 10px;background:#0f0f17;border-radius:8px;cursor:pointer;border:1px solid #ffffff08;">
          <span style="font-family:'JetBrains Mono';font-size:11px;color:#475569;">${f.id}</span>
          <span style="font-size:12px;color:#cbd5e1;flex:1;">${f.name}</span>
          <span class="badge badge-gray" style="font-size:10px;">${moduleName(f.module)}</span>
          ${priorityBadge(f.priority)}
        </div>`;
    });
  }
}

// ============================================================
// BACKLOG
// ============================================================
function renderBacklog() {
  renderSprintSelector('sprint-selector-backlog');

  const sp = data.meta.sprint || {};
  const daysLeft = sp.days_left ?? 0;
  const daysColor = daysLeft <= 3 ? '#ef4444' : daysLeft <= 5 ? '#f59e0b' : '#10b981';
  document.getElementById('sprint-banner').innerHTML = `
    <div>
      <div style="font-size:10px;color:#64748b;font-family:'JetBrains Mono';margin-bottom:4px;">SPRINT ACTIVO</div>
      <div style="font-size:20px;font-weight:700;color:#e2e8f0;">Sprint ${sp.number ?? '—'}</div>
    </div>
    <div style="flex:1;padding:0 16px;border-left:1px solid #1e293b;">
      <div style="font-size:11px;color:#94a3b8;margin-bottom:4px;">Objetivo</div>
      <div style="font-size:13px;color:#cbd5e1;">${sp.goal || '—'}</div>
    </div>
    <div style="text-align:center;min-width:80px;">
      <div style="font-size:28px;font-weight:700;color:${daysColor};">${daysLeft}</div>
      <div style="font-size:11px;color:#64748b;">días restantes</div>
    </div>
    <div style="text-align:center;min-width:80px;">
      <div style="font-size:11px;color:#64748b;margin-bottom:4px;">${sp.start || ''} → ${sp.end || ''}</div>
      <div style="font-size:11px;color:#475569;">Sprint ${sp.number ?? '—'}</div>
    </div>`;

  // Stories filtradas por sprint seleccionado
  const storiesFiltered = getStoriesForSprintFilter();
  const flowIdsInStories = new Set((data.stories || []).flatMap(s => s.flow_ids || []));

  const priorityOrder = { critical:0, high:1, medium:2, low:3 };
  const sorted = [...storiesFiltered].sort((a,b) => (priorityOrder[a.priority] ?? 4) - (priorityOrder[b.priority] ?? 4));

  let html = '';
  sorted.forEach(s => {
    const flows = data.flows.filter(f => (s.flow_ids || []).includes(f.id));
    const flowWithTests = flows.filter(f => (f.test_status === 'covered' || f.test_status === 'partial') && (f.test_files || []).length > 0).length;
    const flowTotal = flows.length;
    const criteriaCount = (s.acceptance_criteria || []).length;
    const list = (s.acceptance_criteria || []).map(c => normCriterion(c, flows));
    const criteriaDone = list.filter(x => x.implemented).length;
    const pct = criteriaCount ? Math.round(criteriaDone / criteriaCount * 100) : 0;
    const allDone = criteriaDone === criteriaCount && criteriaCount > 0;
    const acColor = allDone ? '#10b981' : criteriaDone > 0 ? '#f59e0b' : '#475569';
    const barColor = allDone ? '#10b981' : '#f59e0b';
    const criteriaBadge = criteriaCount ? `${criteriaDone}/${criteriaCount} ✓` : '—';
    const coverageHint = flowTotal || criteriaCount ? `<span style="font-size:10px;color:#64748b;">Flujos ${flowWithTests}/${flowTotal} · Criterios ${criteriaDone}/${criteriaCount}</span>` : '';
    const safeId = String(s.id).replace(/"/g, '&quot;');

    const criteriaHtml = (s.acceptance_criteria && s.acceptance_criteria.length)
      ? s.acceptance_criteria.map((c, i) => criterionCardRow(c, i, flows)).join('')
      : '<div style="font-size:11px;color:#475569;padding:8px 0;">Sin criterios. Añádelos con @update.md.</div>';

    html += `
    <div class="story-card" data-story-id="${safeId}" title="Ver detalles y prompt">
      <div class="story-card-header">
        <span class="story-priority story-priority-${(s.priority || 'medium')}">${(s.priority || 'medium')}</span>
        <div style="flex:1;min-width:0;">
          <div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;">
            <span class="story-card-id">${s.id}</span>
            <span class="story-module">· ${moduleName(s.module)}</span>
          </div>
          <div class="story-card-title">${s.title || s.id}</div>
        </div>
        <span class="story-ac-badge" style="color:${acColor};background:${acColor}18;border:1px solid ${acColor}30;">${criteriaBadge}</span>
      </div>
      ${coverageHint ? `<div style="padding:0 16px 8px;font-size:10px;">${coverageHint}</div>` : ''}
      <div class="story-progress-bar">
        <div class="story-progress-fill" style="width:${pct}%;background:${barColor};"></div>
      </div>
      <div class="story-criteria-list">${criteriaHtml}</div>
    </div>`;
  });

  // Flujos que NO están en ninguna historia (solo cuando se muestra Todos o Backlog)
  const showOrphans = selectedSprintFilter === 'all' || selectedSprintFilter === 'backlog';
  const orphanFlows = showOrphans ? data.flows.filter(f => !flowIdsInStories.has(f.id)) : [];
  if (orphanFlows.length) {
    html += `
    <div style="background:#1e1e2a;border:1px solid #334155;border-radius:10px;padding:16px 20px;margin-bottom:12px;">
      <div style="font-size:11px;color:#64748b;text-transform:uppercase;letter-spacing:.08em;margin-bottom:12px;">Flujos sin historia asignada (${orphanFlows.length})</div>
      <div style="display:flex;flex-direction:column;gap:6px;">
        ${orphanFlows.map(f => `
        <div onclick="openPanel('${f.id}')" style="display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:6px;cursor:pointer;background:#0a0f1e;border:1px solid #1a2540;">
          <span style="font-family:'JetBrains Mono';font-size:10px;color:#475569;min-width:64px;">${f.id}</span>
          <span style="font-size:12px;color:#cbd5e1;flex:1;">${f.name}</span>
          <span class="badge badge-gray" style="font-size:10px;">${moduleName(f.module)}</span>
          ${statusBadge(f.status||'pending')}
          ${testBadge(f.test_status||'none')}
          ${(f.story_points != null) ? `<span style="font-size:11px;font-family:'JetBrains Mono';color:#64748b;">${f.story_points}pts</span>` : ''}
        </div>`).join('')}
      </div>
    </div>`;
  }
  document.getElementById('backlog-content').innerHTML = html;
}

function sprintStatusBadge(s) {
  const map = { todo:['#334155','#94a3b8','Por hacer'], doing:['#1e3a5f','#60a5fa','En progreso'], review:['#3b1f5e','#c084fc','En revisión'], done:['#14532d','#4ade80','Hecho'] };
  const [bg,color,label] = map[s] || map.todo;
  return `<span style="font-size:10px;background:${bg};color:${color};padding:2px 8px;border-radius:4px;font-weight:500;white-space:nowrap;">${label}</span>`;
}

// ============================================================
// BOARD
// ============================================================
function renderBoardFilters() {
  const mf = document.getElementById('board-module-filters');
  const tf = document.getElementById('board-type-filters');
  mf.innerHTML = `<button class="filter-btn active" onclick="setBoardModuleFilter('all',this)">Todos</button>`;
  data.modules.forEach(m=>{
    mf.innerHTML += `<button class="filter-btn" onclick="setBoardModuleFilter('${m.id}',this)">${m.name}</button>`;
  });
  const types = [...new Set(data.flows.map(f=>f.type))];
  tf.innerHTML = `<button class="filter-btn active" onclick="setBoardTypeFilter('all',this)">Todos</button>`;
  types.forEach(t=>{
    tf.innerHTML += `<button class="filter-btn" onclick="setBoardTypeFilter('${t}',this)">${typeLabels[t]||t}</button>`;
  });
}

function setBoardModuleFilter(val, el) {
  boardModuleFilter = val;
  document.querySelectorAll('#board-module-filters .filter-btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  renderBoardColumns();
}

function setBoardTypeFilter(val, el) {
  boardTypeFilter = val;
  document.querySelectorAll('#board-type-filters .filter-btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  renderBoardColumns();
}

function renderBoard() {
  renderSprintSelector('sprint-selector-board');
  renderBoardFilters();
  renderBoardColumns();
}

function renderBoardColumns() {
  let flows = data.flows;
  // Filtro por sprint: solo flujos cuya historia está en el conjunto filtrado (o sin historia si backlog/all)
  const storiesInScope = new Set(getStoriesForSprintFilter().map(s => s.id));
  if (selectedSprintFilter === 'all') {
    // todos los flujos
  } else if (selectedSprintFilter === 'backlog') {
    flows = flows.filter(f => {
      const story = (data.stories || []).find(s => s.id === f.story);
      return !story || story.sprint == null || story.sprint === '';
    });
  } else {
    flows = flows.filter(f => storiesInScope.has(f.story));
  }
  if(boardModuleFilter!=='all') flows = flows.filter(f=>f.module===boardModuleFilter);
  if(boardTypeFilter!=='all')   flows = flows.filter(f=>f.type===boardTypeFilter);

  const cols = { todo:[], doing:[], review:[], done:[] };
  const validCols = ['todo','doing','review','done'];
  flows.forEach(f => {
    const col = (f.sprint_status && validCols.includes(f.sprint_status)) ? f.sprint_status : 'todo';
    cols[col].push(f);
  });

  document.getElementById('count-pending').textContent     = cols.todo.length;
  document.getElementById('count-partial').textContent     = cols.doing.length;
  document.getElementById('count-implemented').textContent = cols.review.length + cols.done.length;

  const colMap = { pending:'todo', partial:'doing', implemented:['review','done'] };

  // renderizar col-pending = todo
  ['todo','doing'].forEach((status, i) => {
    const col = document.getElementById(i===0 ? 'col-pending' : 'col-partial');
    col.innerHTML = '';
    cols[status].forEach(f=>{
      col.innerHTML += flowCard(f);
    });
    if(!cols[status].length) col.innerHTML = '<div style="text-align:center;padding:32px 16px;color:#334155;font-size:12px;">Sin flujos</div>';
  });

  // col-implemented = review + done
  const colImpl = document.getElementById('col-implemented');
  colImpl.innerHTML = '';
  [...cols.review, ...cols.done].forEach(f => colImpl.innerHTML += flowCard(f));
  if(!cols.review.length && !cols.done.length) colImpl.innerHTML = '<div style="text-align:center;padding:32px 16px;color:#334155;font-size:12px;">Sin flujos</div>';
}

function flowCard(f) {
  const story = data.stories.find(s=>s.id===f.story);
  return `
    <div class="flow-card" onclick="openPanel('${f.id}')">
      <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;">
        <span style="font-family:'JetBrains Mono';font-size:10px;color:#475569;">${f.id}</span>
        <div style="flex:1;"></div>
        ${sprintStatusBadge(f.sprint_status)}
      </div>
      <div style="font-size:13px;font-weight:500;color:#e2e8f0;margin-bottom:8px;line-height:1.4;">${f.name}</div>
      ${story ? `<div style="font-size:10px;color:#475569;margin-bottom:6px;font-style:italic;">${story.id}: ${story.title.substring(0,40)}...</div>` : ''}
      <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
        <span class="badge badge-gray" style="font-size:10px;">${moduleName(f.module)}</span>
        ${priorityBadge(f.priority)}
        ${testBadge(f.test_status)}
        <span style="font-size:10px;font-family:'JetBrains Mono';color:#64748b;margin-left:auto;">${f.story_points}pts</span>
      </div>
    </div>`;
}

// ============================================================
// LIST
// ============================================================
function renderListFilters() {
  const lf = document.getElementById('list-module-filters');
  lf.innerHTML = `<button class="filter-btn active" onclick="setListModuleFilter('all',this)">Todos</button>`;
  data.modules.forEach(m=>{
    lf.innerHTML += `<button class="filter-btn" onclick="setListModuleFilter('${m.id}',this)">${m.name}</button>`;
  });
}

function setListModuleFilter(val, el) {
  listModuleFilter = val;
  document.querySelectorAll('#list-module-filters .filter-btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  renderListRows();
}

function filterList() {
  searchQuery = document.getElementById('search-input').value.toLowerCase();
  renderListRows();
}

function renderList() {
  renderListFilters();
  renderListRows();
}

function renderListRows() {
  let flows = data.flows;
  if(listModuleFilter!=='all') flows = flows.filter(f=>f.module===listModuleFilter);
  if(searchQuery) flows = flows.filter(f=>
    f.name.toLowerCase().includes(searchQuery)||
    f.id.toLowerCase().includes(searchQuery)||
    moduleName(f.module).toLowerCase().includes(searchQuery)
  );

  const tbody = document.getElementById('list-body');
  tbody.innerHTML = '';
  flows.forEach(f=>{
    tbody.innerHTML += `
      <tr onclick="openPanel('${f.id}')" style="cursor:pointer;">
        <td><span style="font-family:'JetBrains Mono';font-size:11px;color:#475569;">${f.id}</span></td>
        <td style="color:#e2e8f0;font-weight:500;max-width:260px;">${f.name}</td>
        <td><span class="badge badge-gray">${moduleName(f.module)}</span></td>
        <td style="color:#64748b;font-size:12px;">${typeLabels[f.type]||f.type}</td>
        <td>${statusBadge(f.status||'pending')}</td>
        <td>${testBadge(f.test_status||'none')}</td>
        <td>${priorityBadge(f.priority||'low')}</td>
      </tr>`;
  });
  if(!flows.length) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:32px;color:#334155;">Sin resultados</td></tr>';
  }
}

function exportCSV() {
  const headers = ['ID','Nombre','Módulo','Tipo','Estado','Tests','Prioridad'];
  const rows = data.flows.map(f=>[f.id, f.name, moduleName(f.module), f.type, f.status, f.test_status, f.priority]);
  const csv = [headers, ...rows].map(r=>r.join(',')).join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.download = `${data.meta.app}-flows.csv`;
  a.click();
}

// ============================================================
// ENTITIES
// ============================================================
function renderEntities() {
  const grid = document.getElementById('entities-grid');
  grid.innerHTML = '';
  data.entities.forEach(e=>{
    const colors = e.state_colors || {};
    const statesHtml = e.states.map(s=>{
      const c = colors[s] || '#6366f1';
      return `<span class="state-node" style="background:${c}18;color:${c};border:1px solid ${c}30;">${s}</span>`;
    }).join('');

    const baseStyle = "font-family:'JetBrains Mono';font-size:10px;color:#6366f1;background:#6366f115;padding:2px 6px;border-radius:4px;border:1px solid #6366f125;";
    const transHtml = e.transitions.map(t=>{
      const triggerStr = (t.trigger || '').toString();
      const firstFlowId = triggerStr.split(',')[0].trim();
      const canOpen = firstFlowId && data.flows.some(fl=>fl.id===firstFlowId);
      const onclick = canOpen ? ` onclick="openPanel('${firstFlowId.replace(/'/g,"\\'")}')" style="cursor:pointer;${baseStyle}"` : ` style="${baseStyle}"`;
      return `
        <div class="transition-arrow">
          <span style="font-family:'JetBrains Mono';font-size:11px;color:${colors[t.from]||'#6366f1'};">${t.from}</span>
          <svg width="20" height="12" viewBox="0 0 20 12" fill="none">
            <path d="M0 6h16M12 2l4 4-4 4" stroke="#334155" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
          <span style="font-family:'JetBrains Mono';font-size:11px;color:${colors[t.to]||'#22c55e'};">${t.to}</span>
          <span style="flex:1;"></span>
          <span style="font-size:11px;color:#334155;">${t.label}</span>
          <span${onclick}>${triggerStr}</span>
        </div>`;
    }).join('');

    grid.innerHTML += `
      <div class="entity-card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
          <div>
            <div style="font-size:14px;font-weight:600;color:#e2e8f0;">${e.name}</div>
            <div style="font-size:11px;color:#475569;font-family:'JetBrains Mono';">${e.id}</div>
          </div>
          <span class="badge badge-blue">${e.states.length} estados</span>
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px;">${statesHtml}</div>
        <div style="font-size:11px;color:#334155;text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px;">Transiciones</div>
        <div style="display:flex;flex-direction:column;gap:4px;">${transHtml}</div>
      </div>`;
  });
}

// ============================================================
// PROMPT MAESTRO (por historia) — para que el usuario copie y pegue al agente IA
// Fase 1: implementación. Fase 2: pruebas e2e (prompt separado).
// ============================================================
function buildStoryPrompt(s) {
  const flowIds = s.flow_ids || [];
  const flowIdsStr = flowIds.join(' ');
  const criteria = (s.acceptance_criteria || []).length
    ? (s.acceptance_criteria || []).map(c => `- ${normCriterion(c, null).text}`).join('\n')
    : '- (Añade criterios con @update.md)';
  const implementLine = flowIds.length ? `@implement.md ${flowIdsStr}` : '@implement.md FLOW-XXX';
  return `${implementLine}

Tu tarea es solo implementar la historia siguiente (las pruebas e2e se piden en un paso posterior).

Historia: ${s.id} — ${s.title || ''}
Módulo: ${moduleName(s.module)}
Flujos a implementar: ${flowIds.length ? flowIds.join(', ') : '—'}

Usa .flowdocs/flows.yaml como referencia. Tu implementación debe cumplir estos criterios de aceptación (la validación con e2e y el marcado ✓ en el viewer se hará después):

${criteria}

Al terminar, comprueba que tu implementación cumple cada criterio. Si falta algún criterio en el YAML, proponlo y sugiere actualizar con @update.md.

Al terminar, ejecuta un solo prompt para la documentación: el bloque "2. Generar documentación" (o @document.md). No uses varios prompts; ese uno cubre tests, evidencia y actualización del YAML.`;
}

/** Prompt único para generar documentación (tests + evidencia + YAML) después de implementar. Se extrae y usa como segundo paso. */
function buildStoryDocPrompt(s) {
  const flowIds = s.flow_ids || [];
  const flowIdsStr = flowIds.length ? flowIds.join(', ') : '—';
  return `@document.md — para la historia ${s.id} (${s.title || ''}). Flujos: ${flowIdsStr}.

Sigue @evidence.md para la estructura de carpetas. Un solo paso: tests (crear o documentar existentes), evidencia (capturas/vídeo en .flowdocs/evidence/), y actualización del YAML (test_files, test_evidence, validated, evidence, meta.stats).`;
}

function openSpecModalFromBtn(btn) {
  const acId = btn.getAttribute('data-ac-id') || '—';
  const desc = btn.getAttribute('data-desc') || '';
  let specs = []; try { specs = JSON.parse(btn.getAttribute('data-specs') || '[]'); } catch (_) {}
  let evidence = []; try { evidence = JSON.parse(btn.getAttribute('data-evidence') || '[]'); } catch (_) {}
  document.getElementById('sm-ac').textContent = acId;
  document.getElementById('sm-desc').textContent = desc;
  const img = document.getElementById('sm-img');
  const noEv = document.getElementById('sm-no-evidence');
  if (evidence.length) {
    img.src = evidence[0];
    img.style.display = 'block';
    noEv.style.display = 'none';
  } else {
    img.src = '';
    img.style.display = 'none';
    noEv.style.display = 'flex';
  }
  const shieldSvg = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 3l8 3.5v5c0 4.5-3.5 8.5-8 9.5-4.5-1-8-5-8-9.5v-5L12 3z"/><path d="M9 12l2 2 4-4"/></svg>';
  document.getElementById('sm-files').innerHTML = specs.length ? specs.map(s => '<div class="spec-file-row">' + shieldSvg + s + '</div>').join('') : '<div style="font-size:11px;color:#334155;font-family:\'JetBrains Mono\',monospace;">Sin spec asignado</div>';
  document.getElementById('overlay-spec').classList.add('open');
}
function closeSpecModal() { document.getElementById('overlay-spec').classList.remove('open'); }
function closeLegendModal() { document.getElementById('overlay-legend').classList.remove('open'); }

function openStoryPanel(storyId) {
  const s = data.stories.find(x=>x.id===storyId);
  if(!s) return;
  const promptImplement = buildStoryPrompt(s);
  const promptDoc = buildStoryDocPrompt(s);
  window.__currentStoryPrompt = promptImplement;
  window.__currentStoryPromptE2E = promptDoc;

  const storyFlows = data.flows.filter(f => (s.flow_ids || []).includes(f.id));
  const flowCovered = storyFlows.filter(f => (f.test_status === 'covered' || f.test_status === 'partial') && (f.test_files || []).length > 0).length;
  const flowDone = storyFlows.filter(f => (f.sprint_status || '') === 'done').length;
  const flowTotal = storyFlows.length;
  const criteriaList = (s.acceptance_criteria || []).map(c => normCriterion(c, storyFlows));
  const criteriaDone = criteriaList.filter(x => x.implemented).length;
  const criteriaTotal = criteriaList.length;

  const priorityCls = s.priority === 'critical' ? 'badge badge-err' : s.priority === 'high' ? 'badge badge-warn' : 'badge badge-gray';
  function sprintClass(st) { const v = st || 'todo'; return v === 'in_progress' ? 'doing' : v; }

  let criteriaRowsHtml = '';
  (s.acceptance_criteria || []).forEach((c, i) => {
    const text = normCriterion(c, storyFlows).text;
    const acId = (typeof c === 'object' && c && c.id) ? c.id : ('AC-' + String(i + 1).padStart(3, '0'));
    const dot = criterionDotStyle(c, storyFlows);
    const flows = flowsForCriterion(c, storyFlows);
    const specs = getSpecsForCriterion(c, storyFlows);
    const ev = (typeof c === 'object' && c && Array.isArray(c.evidence)) ? c.evidence : [];
    const chipClass = (f) => 'chip-sprint ' + sprintClass(f.sprint_status);
    const chips = flows.map(f => `<span class="${chipClass(f)}" data-flow-id="${f.id}" onclick="event.stopPropagation();openPanel('${f.id}')">${f.id}</span>`).join('');
    const shieldCls = specs.length ? 'shield-btn' : 'shield-btn no-spec';
    const specsJson = JSON.stringify(specs).replace(/"/g, '&quot;');
    const evidenceJson = JSON.stringify(ev).replace(/"/g, '&quot;');
    const descEsc = String(text).replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    const descAttr = String(text).replace(/"/g,'&quot;');
    criteriaRowsHtml += `<div class="flow-row"><div class="status-dot" style="background:${dot.bg};box-shadow:${dot.glow};"></div><span class="ac-id">${acId}</span><span class="ac-desc" title="${descAttr}">${descEsc}</span><button type="button" class="${shieldCls}" data-ac-id="${acId}" data-desc="${descAttr}" data-specs="${specsJson}" data-evidence="${evidenceJson}" onclick="openSpecModalFromBtn(this)"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 3l8 3.5v5c0 4.5-3.5 8.5-8 9.5-4.5-1-8-5-8-9.5v-5L12 3z"/><path d="M9 12l2 2 4-4"/></svg></button>${chips}</div>`;
  });

  let flowsRowsHtml = '';
  storyFlows.forEach(f => {
    const st = f.sprint_status || 'todo';
    const stCls = sprintClass(st);
    const dotColor = st === 'done' ? '#10b981' : st === 'in_progress' || st === 'doing' || st === 'review' ? (st === 'review' ? '#8b5cf6' : '#3b82f6') : '#475569';
    const glow = st !== 'todo' ? '0 0 5px ' + dotColor + '55' : 'none';
    const sbClass = 'sprint-badge ' + stCls;
    const sbLabel = st === 'in_progress' || st === 'doing' ? 'en curso' : st === 'todo' ? 'todo' : st;
    const testBadge = (f.test_status === 'covered' || f.test_status === 'partial') && (f.test_files || []).length ? '<span style="font-size:10px;font-family:\'JetBrains Mono\',monospace;color:#10b981;background:#10b98112;border:1px solid #10b98125;padding:2px 6px;border-radius:4px;">✓ tests</span>' : '';
    const pts = f.story_points != null ? `<span style="font-size:10px;font-family:'JetBrains Mono',monospace;color:#334155;">${f.story_points}pts</span>` : '';
    flowsRowsHtml += `<div class="flow-row clickable" onclick="openPanel('${f.id}')"><div class="status-dot" style="background:${dotColor};box-shadow:${glow};"></div><span class="flow-id">${f.id}</span><span class="flow-name">${f.name}</span><span class="${sbClass}">${sbLabel}</span>${testBadge}${pts}</div>`;
  });

  const specFilesMap = {};
  (s.acceptance_criteria || []).forEach(c => {
    getSpecsForCriterion(c, storyFlows).forEach(spec => { specFilesMap[spec] = (specFilesMap[spec] || 0) + 1; });
  });
  const specFilesEntries = Object.entries(specFilesMap);
  const specListHtml = specFilesEntries.length ? specFilesEntries.map(([path, count]) => `<div class="spec-list-item"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 3l8 3.5v5c0 4.5-3.5 8.5-8 9.5-4.5-1-8-5-8-9.5v-5L12 3z"/><path d="M9 12l2 2 4-4"/></svg>${path}<span style="margin-left:auto;color:#334155;">${count} criterios</span></div>`).join('') : '';

  const wrapper = document.getElementById('panel-wrapper');
  wrapper.innerHTML = `
    <div class="story-panel-header">
      <div class="header-actions">
        <button type="button" class="legend-btn" title="Guía de indicadores">?</button>
        <button type="button" class="close-btn" onclick="closePanel()"><svg width="10" height="10" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M1 1l10 10M11 1L1 11"/></svg></button>
      </div>
      <div class="story-meta-row">
        <span class="story-meta-id">${s.id}</span>
        <span class="story-meta-module">· ${moduleName(s.module)}</span>
        ${s.sprint != null ? `<span class="story-meta-sprint">Sprint ${s.sprint}</span>` : ''}
      </div>
      <div class="story-panel-title">${String(s.title || s.id).replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
      <div class="story-header-badges">
        <span class="${priorityCls}">${s.priority || 'medium'}</span>
        <span class="story-badge-status">● ${s.status || 'pending'}</span>
        <span class="story-badge-module">${(data.modules.find(m=>m.id===s.module)||{}).name || s.module}</span>
      </div>
    </div>
    <div class="progress-strip">
      <span class="progress-label">AC</span>
      <div class="progress-track"><div class="progress-fill-bar" style="width:${criteriaTotal ? (criteriaDone/criteriaTotal*100) : 0}%;background:#10b981;"></div></div>
      <span class="progress-count" style="color:#10b981;">${criteriaDone}/${criteriaTotal} ✓</span>
      <div style="width:1px;height:18px;background:#1e293b;"></div>
      <span class="progress-label">Flujos</span>
      <div class="progress-track narrow"><div class="progress-fill-bar" style="width:${flowTotal ? (flowDone/flowTotal*100) : 0}%;background:${flowDone===flowTotal ? '#10b981' : '#f59e0b'};"></div></div>
      <span class="progress-count" style="color:${flowDone===flowTotal ? '#10b981' : '#f59e0b'};">${flowDone}/${flowTotal}</span>
    </div>
    <div class="story-panel-body">
      <div class="story-section">
        <div class="section-title">Criterios de Aceptación</div>
        <div style="display:flex;flex-direction:column;gap:4px;">${criteriaRowsHtml || '<div style="font-size:12px;color:#475569;">Sin criterios. Añádelos con @update.md.</div>'}</div>
      </div>
      <div class="story-section">
        <div class="section-title">Flujos (${flowTotal})</div>
        <div style="display:flex;flex-direction:column;gap:4px;">${flowsRowsHtml || '<div style="font-size:12px;color:#475569;">Sin flujos asignados.</div>'}</div>
      </div>
      ${specFilesEntries.length ? `
      <div class="story-section">
        <div class="spec-list-toggle" id="toggle-specs">
          <div class="section-title" style="margin-bottom:0;">Test Files (${specFilesEntries.length})</div>
          <svg id="specs-chevron" width="12" height="12" fill="none" stroke="#475569" stroke-width="2" viewBox="0 0 24 24" style="transition:transform .2s;"><path d="M6 9l6 6 6-6"/></svg>
        </div>
        <div class="spec-list-content" id="specs-list">${specListHtml}</div>
      </div>` : ''}
      <div class="story-section" style="margin-top:16px;">
        <div style="font-size:11px;color:#6366f1;margin-bottom:6px;text-transform:uppercase;letter-spacing:.08em;">1. Implementar</div>
        <pre id="story-prompt-text" style="margin:0;font-size:11px;line-height:1.5;color:#cbd5e1;white-space:pre-wrap;word-break:break-word;max-height:180px;overflow-y:auto;">${promptImplement.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</pre>
        <button type="button" onclick="copyStoryPrompt(1)" style="margin-top:8px;padding:6px 12px;border-radius:6px;border:1px solid #6366f150;background:#6366f118;color:#818cf8;font-size:11px;cursor:pointer;"><span id="copy-btn-label-1">Copiar</span></button>
      </div>
      <div class="story-section">
        <div style="font-size:11px;color:#14b8a6;margin-bottom:6px;text-transform:uppercase;letter-spacing:.08em;">2. Generar documentación</div>
        <pre id="story-prompt-e2e" style="margin:0;font-size:11px;line-height:1.5;color:#cbd5e1;white-space:pre-wrap;word-break:break-word;max-height:160px;overflow-y:auto;">${promptDoc.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</pre>
        <button type="button" onclick="copyStoryPrompt(2)" style="margin-top:8px;padding:6px 12px;border-radius:6px;border:1px solid #0f766e50;background:#0f766e18;color:#2dd4bf;font-size:11px;cursor:pointer;"><span id="copy-btn-label-2">Copiar</span></button>
      </div>
    </div>
  `;
  const legendBtn = wrapper.querySelector('.legend-btn');
  if (legendBtn) legendBtn.onclick = function() { document.getElementById('overlay-legend').classList.add('open'); };
  const toggleSpecs = document.getElementById('toggle-specs');
  if (toggleSpecs) toggleSpecs.onclick = function() { const list = document.getElementById('specs-list'); const chev = document.getElementById('specs-chevron'); if (!list || !chev) return; list.classList.toggle('open'); chev.style.transform = list.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0)'; };
  if (!window.__modalsBound) {
    window.__modalsBound = true;
    document.getElementById('overlay-spec').addEventListener('click', function(e) { if (e.target === this) closeSpecModal(); });
    document.getElementById('overlay-legend').addEventListener('click', function(e) { if (e.target === this) closeLegendModal(); });
    document.addEventListener('keydown', function(e) { if (e.key === 'Escape') { closeSpecModal(); closeLegendModal(); } });
  }

  document.getElementById('detail-panel').classList.add('open');
  document.getElementById('overlay').classList.add('open');
}

// Delegación: clic en card abre modal HU, clic en chip abre panel del flujo.
(function() {
  const el = document.getElementById('backlog-content');
  if (!el) return;
  el.addEventListener('click', function(e) {
    const chip = e.target.closest('[data-flow-id]');
    if (chip) {
      e.preventDefault();
      e.stopPropagation();
      openPanel(chip.getAttribute('data-flow-id'));
      return;
    }
    const card = e.target.closest('.story-card');
    if (card && card.dataset.storyId) {
      e.preventDefault();
      openStoryPanel(card.dataset.storyId);
    }
  });
})();

function copyStoryPrompt(which) {
  const text = which === 2 ? window.__currentStoryPromptE2E : window.__currentStoryPrompt;
  if (!text) return;
  navigator.clipboard.writeText(text).then(() => {
    const lbl = document.getElementById(which === 2 ? 'copy-btn-label-2' : 'copy-btn-label-1');
    if (lbl) { lbl.textContent = 'Copiado'; setTimeout(() => { lbl.textContent = 'Copiar'; }, 2000); }
  });
}

// ============================================================
// DETAIL PANEL (flujo)
// ============================================================
var PANEL_WRAPPER_DEFAULT = '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;"><div id="panel-id" style="font-family:\'JetBrains Mono\';font-size:12px;color:#475569;"></div><button onclick="closePanel()" style="background:none;border:none;color:#475569;cursor:pointer;padding:4px;"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg></button></div><div id="panel-content"></div>';

function openPanel(flowId) {
  const f = data.flows.find(x=>x.id===flowId);
  if(!f) return;
  selectedFlow = f;
  window.__currentStoryPrompt = null;

  const wrapper = document.getElementById('panel-wrapper');
  if (!document.getElementById('panel-id')) {
    wrapper.innerHTML = PANEL_WRAPPER_DEFAULT;
  }

  const story = data.stories.find(s=>s.id===f.story);

  document.getElementById('panel-id').textContent = `${f.id} · ${typeLabels[f.type]||f.type}`;

  const stepsHtml = (Array.isArray(f.steps) ? f.steps : []).map((s,i)=>`
    <div style="display:flex;gap:10px;padding:6px 0;border-bottom:1px solid #ffffff06;">
      <span style="font-family:'JetBrains Mono';font-size:11px;color:#334155;flex-shrink:0;width:16px;">${i+1}</span>
      <span style="font-size:13px;color:#94a3b8;">${s}</span>
    </div>`).join('');

  const altHtml = f.alternatives?.length ? f.alternatives.map(a=>`
    <div style="padding:8px;background:#f59e0b08;border:1px solid #f59e0b18;border-radius:6px;margin-bottom:6px;">
      <div style="font-size:11px;color:#fbbf24;margin-bottom:4px;">Si: ${a.condition}</div>
      ${a.steps.map(s=>`<div style="font-size:12px;color:#94a3b8;padding:2px 0;">→ ${s}</div>`).join('')}
    </div>`).join('') : '<div style="font-size:12px;color:#334155;">Ninguno</div>';

  const errHtml = f.errors?.length ? f.errors.map(e=>`
    <div style="padding:8px;background:#ef444408;border:1px solid #ef444418;border-radius:6px;margin-bottom:6px;">
      <div style="font-size:11px;color:#f87171;margin-bottom:4px;">Si: ${e.condition}</div>
      ${e.steps.map(s=>`<div style="font-size:12px;color:#94a3b8;padding:2px 0;">→ ${s}</div>`).join('')}
    </div>`).join('') : '<div style="font-size:12px;color:#334155;">Ninguno</div>';

  const precondHtml = f.preconditions?.map(p=>`<div style="font-size:12px;color:#94a3b8;padding:3px 0;">· ${p}</div>`).join('')||'';
  const postcondHtml = f.postconditions?.map(p=>`<div style="font-size:12px;color:#94a3b8;padding:3px 0;">· ${p}</div>`).join('')||'';
  const testFilesHtml = f.test_files?.length ? f.test_files.map(t=>`<div style="font-family:'JetBrains Mono';font-size:11px;color:#6366f1;padding:2px 0;">${t}</div>`).join('') : '<div style="font-size:12px;color:#334155;">Sin archivos de test</div>';
  const testEvidenceList = Array.isArray(f.test_evidence) ? f.test_evidence : [];
  const testEvidenceHtml = testEvidenceList.length ? `<div style="margin-top:8px;"><div style="font-size:10px;color:#64748b;margin-bottom:4px;">Evidencia (capturas/vídeo)</div>${testEvidenceList.map(ev => { const ext = (ev.split('.').pop()||'').toLowerCase(); const isV = ['mp4','webm'].includes(ext); return isV ? `<a href="${ev}" target="_blank" rel="noopener" style="font-size:11px;color:#14b8a6;">🎬 ${ev.split('/').pop()}</a>` : `<a href="${ev}" target="_blank" rel="noopener"><img src="${ev}" alt="Evidencia" style="max-width:120px;max-height:80px;object-fit:cover;border-radius:6px;border:1px solid #334155;margin-right:6px;margin-bottom:6px;" onerror="this.style.display='none'"/></a>`; }).join('')}</div>` : '';

  const taskIcons = { done:'✓', doing:'◎', todo:'○' };
  const taskColors = { done:'#10b981', doing:'#60a5fa', todo:'#475569' };
  const tasksHtml = f.tasks?.length ? f.tasks.map(t=>`
    <div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid #ffffff06;">
      <span style="color:${taskColors[t.status]};font-size:14px;">${taskIcons[t.status]}</span>
      <span style="font-family:'JetBrains Mono';font-size:10px;color:#334155;">${t.id}</span>
      <span style="font-size:12px;color:${t.status==='done'?'#475569':'#94a3b8'};${t.status==='done'?'text-decoration:line-through;':''}">${t.name}</span>
    </div>`).join('') : '<div style="font-size:12px;color:#334155;">Sin tasks</div>';

  const panelId = `mermaid-${f.id.replace('-','')}`;

  document.getElementById('panel-content').innerHTML = `
    <div style="margin-bottom:20px;">
      <div style="font-size:18px;font-weight:700;color:#e2e8f0;margin-bottom:10px;line-height:1.3;">${f.name}</div>
      ${f.description ? `<div style="font-size:13px;color:#94a3b8;margin-bottom:12px;line-height:1.4;">${f.description}</div>` : ''}
      <div style="display:flex;flex-wrap:wrap;gap:6px;">
        ${statusBadge(f.status||'pending')}
        ${sprintStatusBadge(f.sprint_status)}
        ${testBadge(f.test_status||'none')}
        ${priorityBadge(f.priority||'low')}
        <span class="badge badge-gray">${moduleName(f.module)}</span>
        ${f.actor ? `<span class="badge badge-gray">${f.actor}</span>` : ''}
        ${(f.story_points != null) ? `<span style="font-size:10px;font-family:'JetBrains Mono';color:#64748b;background:#1e293b;padding:2px 8px;border-radius:4px;">${f.story_points} pts</span>` : ''}
        ${(f.entities && f.entities.length) ? f.entities.map(e=>`<span class="badge badge-blue" style="font-size:10px;">${e}</span>`).join('') : ''}
      </div>
    </div>

    ${story ? `
    <div style="background:#0f1f3d;border:1px solid #1e3a5f;border-radius:8px;padding:12px;margin-bottom:16px;">
      <div style="font-size:10px;color:#3b82f6;margin-bottom:4px;font-family:'JetBrains Mono';">${story.id} · HISTORIA DE USUARIO</div>
      <div style="font-size:13px;color:#93c5fd;">${story.title}</div>
      <button type="button" onclick="openStoryPanel('${story.id}')" style="margin-top:8px;padding:4px 10px;font-size:11px;border-radius:4px;border:1px solid #6366f140;background:#6366f115;color:#818cf8;cursor:pointer;">Ver prompt de la historia →</button>
    </div>` : ''}

    <div style="margin-bottom:16px;">
      <div style="font-size:11px;color:#475569;margin-bottom:8px;text-transform:uppercase;letter-spacing:.08em;">Tasks</div>
      ${tasksHtml}
    </div>

    <div style="background:#0f0f17;border-radius:8px;padding:12px;margin-bottom:16px;">
      <div style="font-size:11px;color:#475569;margin-bottom:6px;text-transform:uppercase;letter-spacing:.08em;">Disparador</div>
      <div style="font-size:13px;color:#cbd5e1;">${f.trigger || '—'}</div>
    </div>

    <div style="margin-bottom:16px;">
      <div style="font-size:11px;color:#475569;margin-bottom:8px;text-transform:uppercase;letter-spacing:.08em;">Precondiciones</div>
      ${precondHtml}
    </div>

    <div style="margin-bottom:16px;">
      <div style="font-size:11px;color:#475569;margin-bottom:8px;text-transform:uppercase;letter-spacing:.08em;">Pasos</div>
      ${stepsHtml}
    </div>

    <div style="margin-bottom:16px;">
      <div style="font-size:11px;color:#475569;margin-bottom:8px;text-transform:uppercase;letter-spacing:.08em;">Flujos Alternativos</div>
      ${altHtml}
    </div>

    <div style="margin-bottom:16px;">
      <div style="font-size:11px;color:#475569;margin-bottom:8px;text-transform:uppercase;letter-spacing:.08em;">Flujos de Error</div>
      ${errHtml}
    </div>

    <div style="margin-bottom:16px;">
      <div style="font-size:11px;color:#475569;margin-bottom:8px;text-transform:uppercase;letter-spacing:.08em;">Postcondiciones</div>
      ${postcondHtml}
    </div>

    <div style="margin-bottom:16px;">
      <div style="font-size:11px;color:#475569;margin-bottom:8px;text-transform:uppercase;letter-spacing:.08em;">Diagrama</div>
      <div class="mermaid" id="${panelId}">${f.diagram ? String(f.diagram).trim() : 'flowchart LR\n  A[Sin diagrama] --> B[—]'}</div>
    </div>

    <div style="margin-bottom:16px;">
      <div style="font-size:11px;color:#475569;margin-bottom:8px;text-transform:uppercase;letter-spacing:.08em;">Archivos de Test (cobertura por flujo)</div>
      ${testFilesHtml}
      ${testEvidenceHtml}
    </div>

    ${f.notes?`
    <div style="background:#6366f108;border:1px solid #6366f118;border-radius:8px;padding:12px;">
      <div style="font-size:11px;color:#6366f1;margin-bottom:4px;">NOTAS</div>
      <div style="font-size:12px;color:#94a3b8;">${f.notes}</div>
    </div>`:''}
  `;

  document.getElementById('detail-panel').classList.add('open');
  document.getElementById('overlay').classList.add('open');

  setTimeout(()=>{
    try { mermaid.run({ nodes: [document.getElementById(panelId)] }); } catch(e) {}
  }, 100);
}


function closePanel() {
  document.getElementById('detail-panel').classList.remove('open');
  document.getElementById('overlay').classList.remove('open');
  selectedFlow = null;
}

// ============================================================
// INIT
// ============================================================
document.addEventListener('DOMContentLoaded', async function() {
  mermaid.initialize({ startOnLoad: false, theme: 'dark', themeVariables: { darkMode: true, background: '#0f0f17', primaryColor: '#6366f1', primaryTextColor: '#e2e8f0', lineColor: '#334155', fontSize: '13px' } });
  try {
    data = await loadFlowDocs();
    dataSource = (data.flows !== MOCK_DATA.flows || data.entities !== MOCK_DATA.entities) ? 'yaml' : 'mock';
    selectedSprintFilter = (data.meta.active_sprint != null) ? data.meta.active_sprint : 'all';
  } catch (e) {
    data = normalizeData(MOCK_DATA);
    dataSource = 'mock';
    selectedSprintFilter = 'all';
  }
  updateDataSourceHint();
  renderDashboard();
});

function updateDataSourceHint() {
  const el = document.getElementById('data-source-hint');
  if (!el) return;
  const banner = document.getElementById('file-protocol-banner');
  if (banner) {
    banner.style.display = (window.location.protocol === 'file:' && dataSource === 'mock') ? 'block' : 'none';
  }
  if (dataSource === 'yaml') {
    el.textContent = 'flows.yaml';
    el.title = 'Datos cargados desde la URL. Usa Recargar para refrescar.';
  } else if (dataSource === 'file') {
    el.textContent = 'archivo';
    el.title = 'Datos cargados desde un archivo. Usa "Cargar archivo" de nuevo para elegir otro flows.yaml.';
  } else {
    el.textContent = 'ejemplo';
    el.title = 'No se pudo cargar por URL (común si abriste como file://). Usa "Cargar archivo" y elige .flowdocs/flows.yaml.';
  }
}

async function reloadYaml() {
  if (window.location.protocol === 'file:') {
    document.getElementById('file-yaml-input').click();
    return;
  }
  data = await loadFlowDocs();
  dataSource = (data.flows !== MOCK_DATA.flows || data.entities !== MOCK_DATA.entities) ? 'yaml' : 'mock';
  selectedSprintFilter = (data.meta.active_sprint != null) ? data.meta.active_sprint : 'all';
  updateDataSourceHint();
  renderDashboard();
  if (activeView === 'backlog') renderBacklog();
  if (activeView === 'board') renderBoard();
  if (activeView === 'list') renderList();
  if (activeView === 'entities') renderEntities();
}
</script>
</body>
</html>
